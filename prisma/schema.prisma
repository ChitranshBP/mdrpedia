generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Geography {
  id        String     @id @default(cuid())
  country   String
  region    String?
  city      String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  hospitals Hospital[]
  profiles  Profile[]

  @@unique([country, region, city])
  @@index([country])
  @@map("geographies")
}

model Hospital {
  id                   String                      @id @default(cuid())
  name                 String
  slug                 String                      @unique
  sector               HealthcareSector            @default(PUBLIC)
  center_of_excellence String?
  ranking_source       String?
  ranking_position     Int?
  website              String?
  description          String?
  logo_url             String?
  geography_id         String?
  createdAt            DateTime                    @default(now())
  updatedAt            DateTime                    @updatedAt
  affiliations         DoctorHospitalAffiliation[]
  geography            Geography?                  @relation(fields: [geography_id], references: [id])

  @@index([sector])
  @@index([geography_id])
  @@map("hospitals")
}

model DoctorHospitalAffiliation {
  id          String   @id @default(cuid())
  role        String?
  department  String?
  start_year  Int?
  end_year    Int?
  is_primary  Boolean  @default(false)
  profile_id  String
  hospital_id String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  hospital    Hospital @relation(fields: [hospital_id], references: [id], onDelete: Cascade)
  profile     Profile  @relation(fields: [profile_id], references: [id], onDelete: Cascade)

  @@unique([profile_id, hospital_id])
  @@index([profile_id])
  @@index([hospital_id])
  @@map("doctor_hospital_affiliations")
}

model Profile {
  id                      String                      @id @default(cuid())
  slug                    String                      @unique
  full_name               String
  title                   String?
  portrait_url            String?
  gallery_urls            String[]                    // Work gallery images
  specialty               String
  sub_specialty           String?
  biography               String?
  status                  ProfileStatus               @default(LIVING)
  tier                    Tier                        @default(UNRANKED)
  ranking_score           Float?
  h_index                 Int                         @default(0)
  years_active            Int                         @default(0)
  verified_surgeries      Int                         @default(0)
  clinical_mastery_index  Float?
  intellectual_legacy     Float?
  global_mentorship_score Float?
  humanitarian_impact     Float?
  has_technique_invention Boolean                     @default(false)
  license_verified        Boolean                     @default(false)
  is_manually_verified    Boolean                     @default(false)
  date_of_birth           DateTime?
  date_of_death           DateTime?
  legacy_decay_score      Float?
  geography_id            String?
  mentored_by_id          String?
  createdAt               DateTime                    @default(now())
  updatedAt               DateTime                    @updatedAt
  ai_summary              String?
  claim_status            ClaimStatus                 @default(UNCLAIMED)
  knows_about             String[]
  medical_specialty       String[]
  npi_number              String?                     @unique
  openalex_id             String?                     @unique
  orcid_id                String?                     @unique
  awards                  Award[]
  certifications          BoardCertification[]
  citations               Citation[]
  affiliations            DoctorHospitalAffiliation[]
  portal                  DoctorPortal?
  historical_artifacts    HistoricalArtifact[]
  impact_metrics          ImpactMetric?
  legacy_timeline         LegacyTimeline[]
  geography               Geography?                  @relation(fields: [geography_id], references: [id])
  mentored_by             Profile?                    @relation("MentorLineage", fields: [mentored_by_id], references: [id])
  mentees                 Profile[]                   @relation("MentorLineage")
  techniques              Technique[]
  tier_verifications      TierVerification[]
  views                   ProfileView[]               // Page view analytics
  media                   ProfileMedia[]              // Videos, images, documents

  @@index([specialty])
  @@index([tier])
  @@index([status])
  @@index([ranking_score])
  @@index([geography_id])
  @@index([claim_status])
  @@map("profiles")
}

model Citation {
  id                      String                  @id @default(cuid())
  doi                     String?                 @unique
  pubmed_id               String?                 @unique
  title                   String
  journal                 String?
  publication_date        DateTime?
  source_url              String?
  altmetric_score         Float?
  citation_count          Int                     @default(0)
  verification_status     VerificationStatus      @default(PENDING)
  verified_at             DateTime?
  rejection_reason        String?
  profile_id              String
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt
  abstract                String?
  evidence_classification EvidenceClassification?
  is_open_access          Boolean                 @default(false)
  journal_impact_factor   Float?
  open_access_url         String?
  total_citation_count    Int?
  profile                 Profile                 @relation(fields: [profile_id], references: [id], onDelete: Cascade)

  @@index([profile_id])
  @@index([verification_status])
  @@index([evidence_classification])
  @@map("citations")
}

model ImpactMetric {
  id                  String    @id @default(cuid())
  lives_saved         Int       @default(0)
  techniques_invented Int       @default(0)
  patients_treated    Int       @default(0)
  clinical_trials_led Int       @default(0)
  textbooks_authored  Int       @default(0)
  data_source         String?
  last_verified       DateTime?
  profile_id          String    @unique
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  profile             Profile   @relation(fields: [profile_id], references: [id], onDelete: Cascade)

  @@map("impact_metrics")
}

model Award {
  id                  String             @id @default(cuid())
  name                String
  issuing_body        String
  year_awarded        Int
  description         String?
  verification_url    String?
  verification_status VerificationStatus @default(PENDING)
  profile_id          String
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  profile             Profile            @relation(fields: [profile_id], references: [id], onDelete: Cascade)

  @@index([profile_id])
  @@map("awards")
}

model Technique {
  id                     String   @id @default(cuid())
  name                   String
  description            String?
  year_invented          Int?
  is_gold_standard       Boolean  @default(false)
  technique_acknowledged Boolean  @default(false)
  patent_number          String?
  verification_url       String?
  profile_id             String
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  profile                Profile  @relation(fields: [profile_id], references: [id], onDelete: Cascade)

  @@index([profile_id])
  @@map("techniques")
}

model BoardCertification {
  id                  String             @id @default(cuid())
  board_name          String
  specialty           String
  license_number      String?
  issuing_body        String
  country             String
  issue_date          DateTime?
  expiry_date         DateTime?
  is_active           Boolean            @default(true)
  verified            Boolean            @default(false)
  verification_status VerificationStatus @default(PENDING)
  profile_id          String
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  profile             Profile            @relation(fields: [profile_id], references: [id], onDelete: Cascade)

  @@index([profile_id])
  @@map("board_certifications")
}

model HistoricalArtifact {
  id             String   @id @default(cuid())
  title          String
  description    String?
  artifact_type  String
  media_url      String?
  archive_source String?
  date_circa     String?
  provenance     String?
  profile_id     String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  profile        Profile  @relation(fields: [profile_id], references: [id], onDelete: Cascade)

  @@index([profile_id])
  @@map("historical_artifacts")
}

model LegacyTimeline {
  id           String   @id @default(cuid())
  year         Int
  title        String
  description  String?
  significance String?
  source_url   String?
  profile_id   String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  profile      Profile  @relation(fields: [profile_id], references: [id], onDelete: Cascade)

  @@index([profile_id])
  @@index([year])
  @@map("legacy_timeline")
}

model TierVerification {
  id                String   @id @default(cuid())
  verifier_name     String
  verifier_tier     Tier
  verification_note String?
  verified_at       DateTime @default(now())
  profile_id        String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  profile           Profile  @relation(fields: [profile_id], references: [id], onDelete: Cascade)

  @@index([profile_id])
  @@map("tier_verifications")
}

model DoctorPortal {
  id                 String             @id @default(cuid())
  google_scholar_id  String?
  google_scholar_url String?
  orcid_url          String?
  accepted_insurance String[]
  patient_philosophy String?
  availability       DoctorAvailability @default(PUBLIC_FACULTY)
  consultation_fee   String?
  booking_url        String?
  languages_spoken   String[]
  profile_id         String             @unique
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  profile            Profile            @relation(fields: [profile_id], references: [id], onDelete: Cascade)

  @@map("doctor_portals")
}

model SearchLog {
  id           String   @id @default(uuid())
  queryText    String
  resultsCount Int
  userId       String?
  ipAddress    String?
  createdAt    DateTime @default(now())
  clickedSlug  String?

  @@index([createdAt])
  @@map("search_logs")
}

model SearchAnalytics {
  id        String   @id @default(cuid())
  term      String   @unique
  count     Int      @default(1)
  updatedAt DateTime @updatedAt

  @@map("search_analytics")
}

model ProfileEdit {
  id                 String     @id @default(cuid())
  profile_slug       String
  field_name         String
  old_value          String?
  new_value          String
  reason             String?
  contributor_name   String
  contributor_email  String
  contributor_social String?
  ip_address         String?
  honeypot_filled    Boolean    @default(false)
  status             EditStatus @default(PENDING)
  reviewed_by        String?
  reviewed_at        DateTime?
  createdAt          DateTime   @default(now())

  @@index([profile_slug])
  @@index([status])
  @@map("profile_edits")
}

model PendingProfile {
  id                 String     @id @default(cuid())
  full_name          String
  specialty          String
  country            String
  city               String?
  hospital           String?
  biography          String?
  date_of_birth      String?
  orcid_id           String?
  npi_number         String?
  contributor_name   String
  contributor_email  String
  contributor_social String?
  ip_address         String?
  honeypot_filled    Boolean    @default(false)
  status             EditStatus @default(PENDING)
  reviewed_by        String?
  reviewed_at        DateTime?
  createdAt          DateTime   @default(now())

  @@index([status])
  @@map("pending_profiles")
}

model ContentPage {
  slug         String         @id
  title        String
  content      String
  published    Boolean        @default(false)
  seo_title    String?
  seo_desc     String?
  seo_keywords String[]       // Focus keywords for SEO
  og_image_url String?        // Custom Open Graph image
  schema_type  String?        // Article, FAQ, HowTo, etc.
  reading_time Int?           // Calculated reading time in minutes
  word_count   Int?           // Auto-calculated word count
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  revisions    PageRevision[]

  @@map("content_pages")
}

model PageRevision {
  id               String      @id @default(cuid())
  page_slug        String
  content_snapshot String
  title_snapshot   String
  changed_by       String
  change_note      String?
  createdAt        DateTime    @default(now())
  page             ContentPage @relation(fields: [page_slug], references: [slug])

  @@index([page_slug])
  @@map("page_revisions")
}

enum Tier {
  TITAN
  ELITE
  MASTER
  UNRANKED
}

enum ProfileStatus {
  LIVING
  HISTORICAL
}

enum VerificationStatus {
  VERIFIED
  PENDING
  REJECTED
}

enum HealthcareSector {
  PUBLIC
  PRIVATE
}

enum ClaimStatus {
  UNCLAIMED
  PENDING
  VERIFIED
  REJECTED
}

enum EvidenceClassification {
  SUPPORTED
  PARTIALLY_SUPPORTED
  HISTORICAL_LANDMARK
}

enum DoctorAvailability {
  PRIVATE_CONSULTANT
  PUBLIC_FACULTY
  BOTH
}

enum EditStatus {
  PENDING
  APPROVED
  REJECTED
}

// ============================================
// ADMIN & ANALYTICS MODELS
// ============================================

model AdminLog {
  id        String   @id @default(cuid())
  action    String   // e.g., "UPDATE_PROFILE", "APPROVE_CLAIM", "BULK_IMPORT"
  target    String   // e.g., profile slug, "system"
  details   String?  // JSON string with additional context
  ipAddress String?
  adminId   String   @default("super-admin")
  createdAt DateTime @default(now())

  @@index([action])
  @@index([target])
  @@index([createdAt])
  @@map("admin_logs")
}

model BulkImportJob {
  id            String   @id @default(cuid())
  fileName      String
  totalRows     Int      @default(0)
  processedRows Int      @default(0)
  successCount  Int      @default(0)
  errorCount    Int      @default(0)
  status        String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  errors        String?  // JSON array of error messages
  adminId       String   @default("super-admin")
  createdAt     DateTime @default(now())
  completedAt   DateTime?

  @@index([status])
  @@index([createdAt])
  @@map("bulk_import_jobs")
}

// ============================================
// PAGE VIEW ANALYTICS
// ============================================

model ProfileView {
  id         String   @id @default(cuid())
  profile_id String
  ip_hash    String   // SHA-256 hashed IP for privacy
  user_agent String?
  referrer   String?
  country    String?
  is_bot     Boolean  @default(false)
  createdAt  DateTime @default(now())
  profile    Profile  @relation(fields: [profile_id], references: [id], onDelete: Cascade)

  @@index([profile_id])
  @@index([createdAt])
  @@index([is_bot])
  @@map("profile_views")
}

// ============================================
// 404 ERROR TRACKING
// ============================================

model NotFoundLog {
  id         String   @id @default(cuid())
  url        String
  referrer   String?
  ip_hash    String
  user_agent String?
  is_bot     Boolean  @default(false)
  resolved   Boolean  @default(false)  // Mark as fixed/ignored
  createdAt  DateTime @default(now())

  @@index([url])
  @@index([createdAt])
  @@index([resolved])
  @@map("not_found_logs")
}

// ============================================
// PROFILE MEDIA (VIDEOS, IMAGES, DOCUMENTS)
// ============================================

model ProfileMedia {
  id          String    @id @default(cuid())
  profile_id  String
  type        MediaType
  url         String
  title       String?
  description String?
  source      String?   // YouTube, Vimeo, Cloudinary, etc.
  video_id    String?   // For embedded videos
  thumbnail   String?
  duration    Int?      // Video duration in seconds
  is_featured Boolean   @default(false)
  sort_order  Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  profile     Profile   @relation(fields: [profile_id], references: [id], onDelete: Cascade)

  @@index([profile_id])
  @@index([type])
  @@map("profile_media")
}

enum MediaType {
  IMAGE
  VIDEO
  DOCUMENT
}
