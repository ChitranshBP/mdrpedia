---
/**
 * MDRPedia ‚Äî Doctor Portal (Self-Service Dashboard)
 * Allows verified doctors to:
 * - Link Google Scholar / ORCID
 * - Add accepted insurance
 * - Write patient philosophy
 * - Set availability
 * - View MDR Score breakdown
 */
import Layout from "../../layouts/Layout.astro";

const pageTitle = "Doctor Portal ‚Äî MDRPedia";
---

<Layout
    title={pageTitle}
    description="Claim and manage your MDRPedia doctor profile. Link ORCID, add insurance, set availability."
>
    <div class="container portal-page">
        <header class="portal-header">
            <h1>Doctor Portal</h1>
            <p class="portal-header__subtitle">
                Manage your verified profile on MDRPedia
            </p>
        </header>

        <!-- Step 1: Verify Identity -->
        <section class="portal-section" id="portal-verify">
            <div class="portal-section__header">
                <span class="portal-step">1</span>
                <h2>Verify Your Identity</h2>
            </div>
            <p class="portal-section__desc">
                Enter your name and NPI number (US) or ORCID to find your
                profile.
            </p>
            <form id="verifyForm" class="portal-form">
                <div class="portal-form__row">
                    <div class="portal-form__field">
                        <label for="fullName">Full Name</label>
                        <input
                            type="text"
                            id="fullName"
                            name="fullName"
                            placeholder="Dr. Jane Smith"
                            required
                        />
                    </div>
                    <div class="portal-form__field">
                        <label for="npiNumber">NPI Number (US)</label>
                        <input
                            type="text"
                            id="npiNumber"
                            name="npiNumber"
                            placeholder="1234567890"
                            pattern="[0-9]{10}"
                        />
                    </div>
                </div>
                <div class="portal-form__row">
                    <div class="portal-form__field">
                        <label for="orcidId">ORCID iD</label>
                        <input
                            type="text"
                            id="orcidId"
                            name="orcidId"
                            placeholder="0000-0002-1234-5678"
                            pattern="\d{4}-\d{4}-\d{4}-\d{3}[\dX]"
                        />
                    </div>
                    <div class="portal-form__field">
                        <label for="googleScholar">Google Scholar ID</label>
                        <input
                            type="text"
                            id="googleScholar"
                            name="googleScholar"
                            placeholder="XhABCDEFGHI"
                        />
                    </div>
                </div>
                <button
                    type="submit"
                    class="portal-btn portal-btn--primary"
                    id="verifyBtn"
                >
                    üîç Find My Profile
                </button>
            </form>
        </section>

        <!-- Step 2: Profile Details (shown after verification) -->
        <section
            class="portal-section portal-section--locked"
            id="portal-details"
        >
            <div class="portal-section__header">
                <span class="portal-step">2</span>
                <h2>Enhance Your Profile</h2>
            </div>
            <p class="portal-section__desc">
                Add clinical details visible to patients and referring
                physicians.
            </p>
            <form id="detailsForm" class="portal-form">
                <div class="portal-form__field portal-form__field--full">
                    <label for="philosophy">Patient Philosophy</label>
                    <textarea
                        id="philosophy"
                        name="philosophy"
                        rows="4"
                        placeholder="Describe your approach to patient care..."
                    ></textarea>
                </div>
                <div class="portal-form__row">
                    <div class="portal-form__field">
                        <label for="availability">Availability</label>
                        <select id="availability" name="availability">
                            <option value="PUBLIC_FACULTY"
                                >Public Faculty</option
                            >
                            <option value="PRIVATE_CONSULTANT"
                                >Private Consultant</option
                            >
                            <option value="BOTH">Both</option>
                        </select>
                    </div>
                    <div class="portal-form__field">
                        <label for="consultationFee">Consultation Fee</label>
                        <input
                            type="text"
                            id="consultationFee"
                            name="consultationFee"
                            placeholder="$500/hour"
                        />
                    </div>
                </div>
                <div class="portal-form__field portal-form__field--full">
                    <label for="insurance"
                        >Accepted Insurance (comma-separated)</label
                    >
                    <input
                        type="text"
                        id="insurance"
                        name="insurance"
                        placeholder="Aetna, Cigna, Blue Cross, NHS"
                    />
                </div>
                <div class="portal-form__field portal-form__field--full">
                    <label for="languages"
                        >Languages Spoken (comma-separated)</label
                    >
                    <input
                        type="text"
                        id="languages"
                        name="languages"
                        placeholder="English, Spanish, French"
                    />
                </div>
                <div class="portal-form__field portal-form__field--full">
                    <label for="bookingUrl">Booking / Appointment URL</label>
                    <input
                        type="url"
                        id="bookingUrl"
                        name="bookingUrl"
                        placeholder="https://myclinic.com/book"
                    />
                </div>
                <button
                    type="submit"
                    class="portal-btn portal-btn--primary"
                    id="submitBtn"
                >
                    üíæ Save Profile
                </button>
            </form>
        </section>

        <!-- Step 3: MDR Score Preview -->
        <section
            class="portal-section portal-section--locked"
            id="portal-score"
        >
            <div class="portal-section__header">
                <span class="portal-step">3</span>
                <h2>Your MDR Score</h2>
            </div>
            <div class="score-preview" id="scorePreview">
                <div class="score-preview__placeholder">
                    <p>
                        Complete Steps 1 and 2 to view your MDR Score breakdown.
                    </p>
                </div>
            </div>
        </section>

        <!-- Status Banner -->
        <div class="portal-status" id="portalStatus" style="display:none;">
            <span class="portal-status__icon"></span>
            <span class="portal-status__message"></span>
        </div>
    </div>
</Layout>

<style>
    .portal-page {
        max-width: 800px;
        margin: 0 auto;
        padding: var(--space-3xl, 3rem) var(--space-lg, 1.25rem);
    }

    .portal-header {
        text-align: center;
        margin-bottom: var(--space-3xl, 3rem);
    }

    .portal-header h1 {
        font-family: var(--font-serif, serif);
        font-size: 2rem;
        background: linear-gradient(135deg, #ffd700, #ff8800);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .portal-header__subtitle {
        color: var(--text-muted, #888);
        font-size: 1rem;
        margin-top: var(--space-xs, 0.25rem);
    }

    .portal-section {
        background: var(--bg-card, #1a1a2e);
        border: 1px solid var(--border-subtle, #2a2a4e);
        border-radius: var(--radius-lg, 12px);
        padding: var(--space-xl, 1.5rem) var(--space-xl, 1.5rem);
        margin-bottom: var(--space-xl, 1.5rem);
        transition:
            opacity 0.3s,
            filter 0.3s;
    }

    .portal-section--locked {
        opacity: 0.4;
        pointer-events: none;
        filter: blur(2px);
    }

    .portal-section--unlocked {
        opacity: 1;
        pointer-events: auto;
        filter: none;
    }

    .portal-section__header {
        display: flex;
        align-items: center;
        gap: var(--space-md, 0.75rem);
        margin-bottom: var(--space-sm, 0.5rem);
    }

    .portal-step {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--accent-purple, #8b5cf6);
        color: white;
        font-weight: 700;
        font-size: 0.85rem;
        flex-shrink: 0;
    }

    .portal-section__desc {
        color: var(--text-muted, #888);
        font-size: 0.85rem;
        margin-bottom: var(--space-lg, 1.25rem);
    }

    .portal-form {
        display: flex;
        flex-direction: column;
        gap: var(--space-md, 0.75rem);
    }

    .portal-form__row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-md, 0.75rem);
    }

    .portal-form__field {
        display: flex;
        flex-direction: column;
        gap: var(--space-xs, 0.25rem);
    }

    .portal-form__field--full {
        grid-column: 1 / -1;
    }

    .portal-form__field label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-secondary, #aaa);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .portal-form__field input,
    .portal-form__field select,
    .portal-form__field textarea {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-subtle, #2a2a4e);
        border-radius: var(--radius-md, 8px);
        padding: var(--space-sm, 0.5rem) var(--space-md, 0.75rem);
        color: var(--text-primary, #e0e0e0);
        font-family: var(--font-sans, sans-serif);
        font-size: 0.9rem;
        transition: border-color 0.2s;
    }

    .portal-form__field input:focus,
    .portal-form__field select:focus,
    .portal-form__field textarea:focus {
        outline: none;
        border-color: var(--accent-purple, #8b5cf6);
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15);
    }

    .portal-btn {
        padding: var(--space-sm, 0.5rem) var(--space-xl, 1.5rem);
        border: none;
        border-radius: var(--radius-md, 8px);
        font-weight: 700;
        font-size: 0.9rem;
        cursor: pointer;
        transition:
            transform 0.15s,
            box-shadow 0.15s;
        align-self: flex-start;
    }

    .portal-btn--primary {
        background: linear-gradient(135deg, #8b5cf6, #6d28d9);
        color: white;
    }

    .portal-btn--primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
    }

    .portal-status {
        position: fixed;
        bottom: var(--space-xl, 1.5rem);
        right: var(--space-xl, 1.5rem);
        background: var(--bg-card, #1a1a2e);
        border: 1px solid var(--border-subtle, #2a2a4e);
        border-radius: var(--radius-lg, 12px);
        padding: var(--space-md, 0.75rem) var(--space-lg, 1.25rem);
        display: flex;
        align-items: center;
        gap: var(--space-sm, 0.5rem);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .score-preview__placeholder {
        text-align: center;
        color: var(--text-muted, #888);
        padding: var(--space-xl, 1.5rem);
    }

    @media (max-width: 640px) {
        .portal-form__row {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const verifyForm = document.getElementById(
            "verifyForm",
        ) as HTMLFormElement;
        const detailsSection = document.getElementById("portal-details")!;
        const scoreSection = document.getElementById("portal-score")!;
        const status = document.getElementById("portalStatus")!;

        function showStatus(message: string, type: "success" | "error") {
            const icon = status.querySelector(".portal-status__icon")!;
            const msg = status.querySelector(".portal-status__message")!;
            icon.textContent = type === "success" ? "‚úÖ" : "‚ùå";
            msg.textContent = message;
            status.style.display = "flex";
            setTimeout(() => {
                status.style.display = "none";
            }, 4000);
        }

        // Step 1: Verify
        verifyForm?.addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(verifyForm);

            try {
                const res = await fetch("/api/portal", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        action: "verify",
                        fullName: formData.get("fullName"),
                        npiNumber: formData.get("npiNumber"),
                        orcidId: formData.get("orcidId"),
                        googleScholarId: formData.get("googleScholar"),
                    }),
                });

                if (res.ok) {
                    detailsSection.classList.remove("portal-section--locked");
                    detailsSection.classList.add("portal-section--unlocked");
                    scoreSection.classList.remove("portal-section--locked");
                    scoreSection.classList.add("portal-section--unlocked");
                    showStatus(
                        "Profile found! Fill in your details below.",
                        "success",
                    );
                } else {
                    showStatus(
                        "Profile not found. Check your name and NPI/ORCID.",
                        "error",
                    );
                }
            } catch {
                showStatus("Network error. Please try again.", "error");
            }
        });

        // Step 2: Save details
        const detailsForm = document.getElementById(
            "detailsForm",
        ) as HTMLFormElement;
        detailsForm?.addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(detailsForm);

            try {
                const res = await fetch("/api/portal", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        action: "update",
                        philosophy: formData.get("philosophy"),
                        availability: formData.get("availability"),
                        consultationFee: formData.get("consultationFee"),
                        insurance: (formData.get("insurance") as string)
                            ?.split(",")
                            .map((s) => s.trim())
                            .filter(Boolean),
                        languages: (formData.get("languages") as string)
                            ?.split(",")
                            .map((s) => s.trim())
                            .filter(Boolean),
                        bookingUrl: formData.get("bookingUrl"),
                    }),
                });

                if (res.ok) {
                    showStatus("Profile updated successfully!", "success");
                } else {
                    showStatus("Failed to update profile.", "error");
                }
            } catch {
                showStatus("Network error. Please try again.", "error");
            }
        });
    });
</script>
