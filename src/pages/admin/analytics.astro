---
/**
 * MDRPedia — Analytics Dashboard
 * View page views and traffic statistics
 */
import Layout from "../../layouts/Layout.astro";
import { prisma } from "../../lib/prisma";
import { requireSuperAdmin } from "../../lib/rbac";

export const prerender = false;

if (!requireSuperAdmin(Astro.request)) {
    return Astro.redirect("/login");
}

const url = new URL(Astro.request.url);
const adminKey = url.searchParams.get("key") || "";

// Date range (default: last 30 days)
const daysAgo = parseInt(url.searchParams.get("days") || "30");
const startDate = new Date();
startDate.setDate(startDate.getDate() - daysAgo);

// Fetch analytics data
let stats = {
    totalViews: 0,
    humanViews: 0,
    botViews: 0,
    uniqueProfiles: 0
};
let topProfiles: any[] = [];
let topReferrers: any[] = [];
let dailyViews: any[] = [];

try {
    // Overall stats
    const [totalViews, humanViews, botViews, uniqueProfiles] = await Promise.all([
        prisma.profileView.count({
            where: { createdAt: { gte: startDate } }
        }),
        prisma.profileView.count({
            where: { createdAt: { gte: startDate }, is_bot: false }
        }),
        prisma.profileView.count({
            where: { createdAt: { gte: startDate }, is_bot: true }
        }),
        prisma.profileView.groupBy({
            by: ['profile_id'],
            where: { createdAt: { gte: startDate } }
        }).then(r => r.length)
    ]);

    stats = { totalViews, humanViews, botViews, uniqueProfiles };

    // Top viewed profiles (human traffic only)
    const topProfileViews = await prisma.profileView.groupBy({
        by: ['profile_id'],
        where: {
            createdAt: { gte: startDate },
            is_bot: false
        },
        _count: { profile_id: true },
        orderBy: { _count: { profile_id: 'desc' } },
        take: 15
    });

    // Fetch profile details
    const profileIds = topProfileViews.map(p => p.profile_id);
    const profiles = await prisma.profile.findMany({
        where: { id: { in: profileIds } },
        select: { id: true, full_name: true, slug: true, tier: true }
    });

    const profileMap = new Map(profiles.map(p => [p.id, p]));
    topProfiles = topProfileViews.map(v => ({
        ...profileMap.get(v.profile_id),
        viewCount: v._count.profile_id
    })).filter(p => p.full_name);

    // Top referrers
    const referrerGroups = await prisma.profileView.groupBy({
        by: ['referrer'],
        where: {
            createdAt: { gte: startDate },
            is_bot: false,
            referrer: { not: null }
        },
        _count: { referrer: true },
        orderBy: { _count: { referrer: 'desc' } },
        take: 10
    });

    topReferrers = referrerGroups.map(r => {
        let hostname = 'Direct';
        try {
            if (r.referrer) hostname = new URL(r.referrer).hostname;
        } catch {}
        return {
            referrer: r.referrer,
            hostname,
            count: r._count.referrer
        };
    });

} catch (e) {
    console.error("Analytics error:", e);
}

// Format number with K/M suffix
function formatNumber(num: number): string {
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
    return num.toLocaleString();
}
---

<Layout title="Analytics — Admin">
    <div class="admin-page">
        <aside class="sidebar">
            <div class="sidebar__brand">
                <a href={`/admin?key=${adminKey}`} class="brand-link">
                    <div class="brand-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 21h18M5 21V7l7-4 7 4v14M9 21v-6h6v6"/>
                        </svg>
                    </div>
                    <span>MDRPedia</span>
                </a>
            </div>
            <nav class="sidebar__nav">
                <a href={`/admin?key=${adminKey}`} class="nav-item">Dashboard</a>
                <a href={`/admin/doctors?key=${adminKey}`} class="nav-item">All Doctors</a>
                <a href={`/admin/audit-log?key=${adminKey}`} class="nav-item">Activity Log</a>
                <a href={`/admin/data-quality?key=${adminKey}`} class="nav-item">Data Quality</a>
                <a href={`/admin/bulk-import?key=${adminKey}`} class="nav-item">Bulk Import</a>
                <a href={`/admin/analytics?key=${adminKey}`} class="nav-item active">Analytics</a>
                <a href={`/admin/broken-links?key=${adminKey}`} class="nav-item">Broken Links</a>
            </nav>
        </aside>

        <main class="main-content">
            <header class="page-header">
                <div>
                    <h1>Analytics</h1>
                    <p>Page view statistics and traffic insights</p>
                </div>
                <div class="date-filter">
                    <select id="daysFilter" onchange="location.href=`/admin/analytics?key=${adminKey}&days=${this.value}`">
                        <option value="7" selected={daysAgo === 7}>Last 7 days</option>
                        <option value="30" selected={daysAgo === 30}>Last 30 days</option>
                        <option value="90" selected={daysAgo === 90}>Last 90 days</option>
                        <option value="365" selected={daysAgo === 365}>Last year</option>
                    </select>
                </div>
            </header>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon stat-icon--purple">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <span class="stat-value">{formatNumber(stats.totalViews)}</span>
                        <span class="stat-label">Total Views</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon stat-icon--green">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <span class="stat-value">{formatNumber(stats.humanViews)}</span>
                        <span class="stat-label">Human Views</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon stat-icon--gray">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2"/>
                            <circle cx="12" cy="5" r="3"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <span class="stat-value">{formatNumber(stats.botViews)}</span>
                        <span class="stat-label">Bot Views</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon stat-icon--blue">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <span class="stat-value">{formatNumber(stats.uniqueProfiles)}</span>
                        <span class="stat-label">Profiles Viewed</span>
                    </div>
                </div>
            </div>

            <div class="two-column">
                <!-- Top Profiles -->
                <div class="card">
                    <h2>Top Viewed Profiles</h2>
                    <p class="help-text">Human traffic only</p>
                    {topProfiles.length > 0 ? (
                        <div class="profile-list">
                            {topProfiles.map((profile, i) => (
                                <div class="profile-item">
                                    <span class="profile-rank">{i + 1}</span>
                                    <div class="profile-info">
                                        <a href={`/doctors/${profile.slug}`} target="_blank" class="profile-name">
                                            {profile.full_name}
                                        </a>
                                        <span class={`tier-badge tier-badge--${profile.tier?.toLowerCase()}`}>
                                            {profile.tier}
                                        </span>
                                    </div>
                                    <span class="profile-views">{formatNumber(profile.viewCount)}</span>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <p class="empty-state">No view data available yet</p>
                    )}
                </div>

                <!-- Top Referrers -->
                <div class="card">
                    <h2>Top Referrers</h2>
                    <p class="help-text">Where traffic comes from</p>
                    {topReferrers.length > 0 ? (
                        <div class="referrer-list">
                            {topReferrers.map((ref, i) => (
                                <div class="referrer-item">
                                    <span class="referrer-rank">{i + 1}</span>
                                    <span class="referrer-host">{ref.hostname}</span>
                                    <span class="referrer-count">{formatNumber(ref.count)}</span>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <p class="empty-state">No referrer data available yet</p>
                    )}
                </div>
            </div>
        </main>
    </div>
</Layout>

<style>
    .admin-page {
        display: flex;
        min-height: 100vh;
        background: #0a0a12;
    }

    .sidebar {
        width: 220px;
        background: rgba(15, 15, 25, 0.95);
        border-right: 1px solid rgba(255, 255, 255, 0.06);
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        padding: 20px 0;
    }

    .sidebar__brand {
        padding: 0 20px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        margin-bottom: 16px;
    }

    .brand-link {
        display: flex;
        align-items: center;
        gap: 10px;
        text-decoration: none;
        color: white;
        font-weight: 700;
    }

    .brand-icon {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #8b5cf6, #6366f1);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .brand-icon svg {
        width: 18px;
        height: 18px;
    }

    .sidebar__nav {
        display: flex;
        flex-direction: column;
        gap: 4px;
        padding: 0 12px;
    }

    .nav-item {
        padding: 10px 12px;
        border-radius: 8px;
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 0.875rem;
        transition: all 0.15s;
    }

    .nav-item:hover {
        background: rgba(255, 255, 255, 0.05);
        color: white;
    }

    .nav-item.active {
        background: rgba(139, 92, 246, 0.15);
        color: #8b5cf6;
    }

    .main-content {
        flex: 1;
        margin-left: 220px;
        padding: 32px;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 32px;
    }

    .page-header h1 {
        font-size: 1.75rem;
        font-weight: 700;
        color: white;
        margin-bottom: 4px;
    }

    .page-header p {
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    .date-filter select {
        padding: 8px 14px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        color: white;
        font-size: 0.9rem;
        cursor: pointer;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 32px;
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 12px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .stat-icon svg {
        width: 24px;
        height: 24px;
    }

    .stat-icon--purple {
        background: rgba(139, 92, 246, 0.15);
        color: #8b5cf6;
    }

    .stat-icon--green {
        background: rgba(34, 197, 94, 0.15);
        color: #22c55e;
    }

    .stat-icon--gray {
        background: rgba(156, 163, 175, 0.15);
        color: #9ca3af;
    }

    .stat-icon--blue {
        background: rgba(59, 130, 246, 0.15);
        color: #3b82f6;
    }

    .stat-content {
        display: flex;
        flex-direction: column;
    }

    .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: white;
        line-height: 1.2;
    }

    .stat-label {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    /* Two Column */
    .two-column {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
    }

    /* Card */
    .card {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 12px;
        padding: 24px;
    }

    .card h2 {
        font-size: 1.1rem;
        font-weight: 600;
        color: white;
        margin-bottom: 4px;
    }

    .help-text {
        color: var(--text-muted);
        font-size: 0.85rem;
        margin-bottom: 16px;
    }

    /* Profile List */
    .profile-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .profile-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
    }

    .profile-rank {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted);
    }

    .profile-info {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .profile-name {
        color: white;
        text-decoration: none;
        font-weight: 500;
        font-size: 0.9rem;
    }

    .profile-name:hover {
        color: #8b5cf6;
    }

    .tier-badge {
        font-size: 0.6rem;
        font-weight: 700;
        padding: 2px 6px;
        border-radius: 4px;
        text-transform: uppercase;
    }

    .tier-badge--titan { background: rgba(255, 215, 0, 0.15); color: #ffd700; }
    .tier-badge--elite { background: rgba(0, 170, 255, 0.15); color: #00aaff; }
    .tier-badge--master { background: rgba(0, 204, 102, 0.15); color: #00cc66; }
    .tier-badge--unranked { background: rgba(156, 163, 175, 0.15); color: #9ca3af; }

    .profile-views {
        font-size: 0.9rem;
        font-weight: 600;
        color: #8b5cf6;
    }

    /* Referrer List */
    .referrer-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .referrer-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
    }

    .referrer-rank {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted);
    }

    .referrer-host {
        flex: 1;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .referrer-count {
        font-size: 0.9rem;
        font-weight: 600;
        color: #22c55e;
    }

    .empty-state {
        text-align: center;
        padding: 32px;
        color: var(--text-muted);
    }

    @media (max-width: 1200px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 1024px) {
        .sidebar {
            display: none;
        }
        .main-content {
            margin-left: 0;
        }
        .two-column {
            grid-template-columns: 1fr;
        }
    }
</style>
