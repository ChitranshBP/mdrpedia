---
/**
 * MDRPedia — Data Quality Dashboard
 * View profile completeness and missing data reports
 */
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";
import { prisma } from "../../lib/prisma";
import { requireSuperAdmin } from "../../lib/rbac";

export const prerender = false;

if (!requireSuperAdmin(Astro.request)) {
    return Astro.redirect("/login");
}

const url = new URL(Astro.request.url);
const adminKey = url.searchParams.get("key") || "";
const sortBy = url.searchParams.get("sort") || "completeness";
const filterMissing = url.searchParams.get("missing") || "";

// Calculate completeness score for a profile
function calculateCompleteness(profile: any): { score: number; missing: string[] } {
    const fields = [
        { name: 'Biography', check: () => profile.biography && profile.biography.length > 50 },
        { name: 'Portrait', check: () => !!profile.portraitUrl },
        { name: 'H-Index', check: () => profile.hIndex && profile.hIndex > 0 },
        { name: 'Citations', check: () => profile.citations && profile.citations.length > 0 },
        { name: 'Awards', check: () => profile.awards && profile.awards.length > 0 },
        { name: 'Affiliations', check: () => profile.affiliations && profile.affiliations.length > 0 },
        { name: 'Geography', check: () => profile.geography?.country && profile.geography.country !== 'Unknown' },
        { name: 'Specialty', check: () => !!profile.specialty },
        { name: 'Timeline', check: () => profile.timeline && profile.timeline.length > 0 },
        { name: 'Mentors/Students', check: () => (profile.mentors?.length > 0) || (profile.students?.length > 0) },
    ];

    const missing: string[] = [];
    let filled = 0;

    fields.forEach(field => {
        if (field.check()) {
            filled++;
        } else {
            missing.push(field.name);
        }
    });

    return {
        score: Math.round((filled / fields.length) * 100),
        missing
    };
}

// Fetch all doctors
const doctors = await getCollection("doctors");

// Calculate completeness for each
const profilesWithScores = doctors.map(doc => {
    const d = doc.data;
    const { score, missing } = calculateCompleteness(d);
    return {
        slug: doc.id,
        fullName: d.fullName,
        tier: d.tier,
        specialty: d.specialty,
        score,
        missing,
        hasPhoto: !!d.portraitUrl,
        hasBio: d.biography && d.biography.length > 50,
        hasCitations: d.citations && d.citations.length > 0,
        hasAwards: d.awards && d.awards.length > 0,
        hIndex: d.hIndex || 0,
    };
});

// Filter by missing field if specified
let filteredProfiles = profilesWithScores;
if (filterMissing) {
    filteredProfiles = profilesWithScores.filter(p => p.missing.includes(filterMissing));
}

// Sort profiles
if (sortBy === 'completeness') {
    filteredProfiles.sort((a, b) => a.score - b.score);
} else if (sortBy === 'name') {
    filteredProfiles.sort((a, b) => a.fullName.localeCompare(b.fullName));
} else if (sortBy === 'tier') {
    const tierOrder = { TITAN: 0, ELITE: 1, MASTER: 2, UNRANKED: 3 };
    filteredProfiles.sort((a, b) => (tierOrder[a.tier] || 3) - (tierOrder[b.tier] || 3));
}

// Calculate summary stats
const avgScore = Math.round(profilesWithScores.reduce((sum, p) => sum + p.score, 0) / profilesWithScores.length);
const missingPhotos = profilesWithScores.filter(p => !p.hasPhoto).length;
const missingBios = profilesWithScores.filter(p => !p.hasBio).length;
const missingCitations = profilesWithScores.filter(p => !p.hasCitations).length;
const completeProfiles = profilesWithScores.filter(p => p.score === 100).length;

// Get color for score
function getScoreColor(score: number): string {
    if (score >= 80) return 'green';
    if (score >= 50) return 'yellow';
    return 'red';
}

// Get tier color
function getTierColor(tier: string): string {
    if (tier === 'TITAN') return 'gold';
    if (tier === 'ELITE') return 'blue';
    if (tier === 'MASTER') return 'green';
    return 'gray';
}
---

<Layout title="Data Quality — Admin">
    <div class="admin-page">
        <aside class="sidebar">
            <div class="sidebar__brand">
                <a href={`/admin?key=${adminKey}`} class="brand-link">
                    <div class="brand-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 21h18M5 21V7l7-4 7 4v14M9 21v-6h6v6"/>
                        </svg>
                    </div>
                    <span>MDRPedia</span>
                </a>
            </div>
            <nav class="sidebar__nav">
                <a href={`/admin?key=${adminKey}`} class="nav-item">Dashboard</a>
                <a href={`/admin/doctors?key=${adminKey}`} class="nav-item">All Doctors</a>
                <a href={`/admin/news?key=${adminKey}`} class="nav-item">News</a>
                <a href={`/admin/claims?key=${adminKey}`} class="nav-item">Claims</a>
                <a href={`/admin/audit-log?key=${adminKey}`} class="nav-item">Activity Log</a>
                <a href={`/admin/data-quality?key=${adminKey}`} class="nav-item active">Data Quality</a>
                <a href={`/admin/bulk-import?key=${adminKey}`} class="nav-item">Bulk Import</a>
            </nav>
        </aside>

        <main class="main-content">
            <header class="page-header">
                <div>
                    <h1>Data Quality Report</h1>
                    <p>Profile completeness and missing data analysis</p>
                </div>
            </header>

            <!-- Summary Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card__value">{avgScore}%</div>
                    <div class="stat-card__label">Avg Completeness</div>
                    <div class="stat-card__bar">
                        <div class="stat-card__fill" style={`width: ${avgScore}%`}></div>
                    </div>
                </div>
                <div class="stat-card stat-card--clickable" onclick={`window.location='?key=${adminKey}&missing=Portrait'`}>
                    <div class="stat-card__value stat-card__value--red">{missingPhotos}</div>
                    <div class="stat-card__label">Missing Photos</div>
                </div>
                <div class="stat-card stat-card--clickable" onclick={`window.location='?key=${adminKey}&missing=Biography'`}>
                    <div class="stat-card__value stat-card__value--red">{missingBios}</div>
                    <div class="stat-card__label">Missing Bios</div>
                </div>
                <div class="stat-card stat-card--clickable" onclick={`window.location='?key=${adminKey}&missing=Citations'`}>
                    <div class="stat-card__value stat-card__value--yellow">{missingCitations}</div>
                    <div class="stat-card__label">No Citations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card__value stat-card__value--green">{completeProfiles}</div>
                    <div class="stat-card__label">100% Complete</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters-bar">
                <div class="filter-group">
                    <label>Sort By</label>
                    <select onchange={`window.location='?key=${adminKey}&sort=' + this.value + '${filterMissing ? `&missing=${filterMissing}` : ''}'`}>
                        <option value="completeness" selected={sortBy === 'completeness'}>Lowest Completeness</option>
                        <option value="name" selected={sortBy === 'name'}>Name</option>
                        <option value="tier" selected={sortBy === 'tier'}>Tier</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Missing Field</label>
                    <select onchange={`window.location='?key=${adminKey}&sort=${sortBy}&missing=' + this.value`}>
                        <option value="">All Profiles</option>
                        <option value="Portrait" selected={filterMissing === 'Portrait'}>Missing Portrait</option>
                        <option value="Biography" selected={filterMissing === 'Biography'}>Missing Biography</option>
                        <option value="Citations" selected={filterMissing === 'Citations'}>Missing Citations</option>
                        <option value="Awards" selected={filterMissing === 'Awards'}>Missing Awards</option>
                        <option value="H-Index" selected={filterMissing === 'H-Index'}>Missing H-Index</option>
                        <option value="Affiliations" selected={filterMissing === 'Affiliations'}>Missing Affiliations</option>
                        <option value="Mentors/Students" selected={filterMissing === 'Mentors/Students'}>Missing Lineage</option>
                    </select>
                </div>
                {filterMissing && (
                    <a href={`/admin/data-quality?key=${adminKey}`} class="btn btn--outline">Clear Filter</a>
                )}
                <div class="filter-results">
                    Showing {filteredProfiles.length} of {profilesWithScores.length} profiles
                </div>
            </div>

            <!-- Profiles Table -->
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Doctor</th>
                            <th>Tier</th>
                            <th>Completeness</th>
                            <th>Missing Fields</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {filteredProfiles.slice(0, 100).map((profile) => (
                            <tr>
                                <td class="cell-doctor">
                                    <div class="doctor-info">
                                        <span class="doctor-name">{profile.fullName}</span>
                                        <span class="doctor-specialty">{profile.specialty}</span>
                                    </div>
                                </td>
                                <td>
                                    <span class={`tier-badge tier-badge--${getTierColor(profile.tier)}`}>
                                        {profile.tier}
                                    </span>
                                </td>
                                <td class="cell-score">
                                    <div class="score-display">
                                        <div class="score-bar">
                                            <div class={`score-fill score-fill--${getScoreColor(profile.score)}`} style={`width: ${profile.score}%`}></div>
                                        </div>
                                        <span class={`score-value score-value--${getScoreColor(profile.score)}`}>{profile.score}%</span>
                                    </div>
                                </td>
                                <td class="cell-missing">
                                    {profile.missing.length > 0 ? (
                                        <div class="missing-tags">
                                            {profile.missing.slice(0, 3).map(field => (
                                                <span class="missing-tag">{field}</span>
                                            ))}
                                            {profile.missing.length > 3 && (
                                                <span class="missing-more">+{profile.missing.length - 3} more</span>
                                            )}
                                        </div>
                                    ) : (
                                        <span class="complete-badge">Complete</span>
                                    )}
                                </td>
                                <td>
                                    <a href={`/admin/doctors/${profile.slug}?key=${adminKey}`} class="btn btn--sm btn--outline">Edit</a>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {filteredProfiles.length > 100 && (
                <p class="table-note">Showing first 100 results. Apply filters to narrow down.</p>
            )}
        </main>
    </div>
</Layout>

<style>
    .admin-page {
        display: flex;
        min-height: 100vh;
        background: #0a0a12;
    }

    .sidebar {
        width: 220px;
        background: rgba(15, 15, 25, 0.95);
        border-right: 1px solid rgba(255, 255, 255, 0.06);
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        padding: 20px 0;
    }

    .sidebar__brand {
        padding: 0 20px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        margin-bottom: 16px;
    }

    .brand-link {
        display: flex;
        align-items: center;
        gap: 10px;
        text-decoration: none;
        color: white;
        font-weight: 700;
    }

    .brand-icon {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #8b5cf6, #6366f1);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .brand-icon svg {
        width: 18px;
        height: 18px;
    }

    .sidebar__nav {
        display: flex;
        flex-direction: column;
        gap: 4px;
        padding: 0 12px;
    }

    .nav-item {
        padding: 10px 12px;
        border-radius: 8px;
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 0.875rem;
        transition: all 0.15s;
    }

    .nav-item:hover {
        background: rgba(255, 255, 255, 0.05);
        color: white;
    }

    .nav-item.active {
        background: rgba(139, 92, 246, 0.15);
        color: #8b5cf6;
    }

    .main-content {
        flex: 1;
        margin-left: 220px;
        padding: 32px;
    }

    .page-header {
        margin-bottom: 32px;
    }

    .page-header h1 {
        font-size: 1.75rem;
        font-weight: 700;
        color: white;
        margin-bottom: 4px;
    }

    .page-header p {
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 16px;
        margin-bottom: 24px;
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 12px;
        padding: 20px;
    }

    .stat-card--clickable {
        cursor: pointer;
        transition: all 0.15s;
    }

    .stat-card--clickable:hover {
        background: rgba(255, 255, 255, 0.04);
        border-color: rgba(255, 255, 255, 0.1);
    }

    .stat-card__value {
        font-size: 2rem;
        font-weight: 700;
        color: white;
        line-height: 1.2;
    }

    .stat-card__value--red { color: #ef4444; }
    .stat-card__value--yellow { color: #f59e0b; }
    .stat-card__value--green { color: #22c55e; }

    .stat-card__label {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-top: 4px;
    }

    .stat-card__bar {
        margin-top: 12px;
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
        overflow: hidden;
    }

    .stat-card__fill {
        height: 100%;
        background: linear-gradient(90deg, #8b5cf6, #22c55e);
        border-radius: 2px;
    }

    /* Filters */
    .filters-bar {
        display: flex;
        gap: 16px;
        align-items: flex-end;
        margin-bottom: 24px;
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .filter-group label {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .filter-group select {
        padding: 8px 12px;
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        color: white;
        font-size: 0.9rem;
        min-width: 180px;
    }

    .filter-results {
        margin-left: auto;
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    /* Table */
    .table-container {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 12px;
        overflow: hidden;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th {
        text-align: left;
        padding: 12px 16px;
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        background: rgba(0, 0, 0, 0.2);
    }

    .data-table td {
        padding: 12px 16px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        vertical-align: middle;
    }

    .cell-doctor {
        min-width: 200px;
    }

    .doctor-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .doctor-name {
        font-weight: 600;
        color: white;
    }

    .doctor-specialty {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .tier-badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
    }

    .tier-badge--gold { background: rgba(255, 215, 0, 0.15); color: #ffd700; }
    .tier-badge--blue { background: rgba(0, 170, 255, 0.15); color: #00aaff; }
    .tier-badge--green { background: rgba(0, 204, 102, 0.15); color: #00cc66; }
    .tier-badge--gray { background: rgba(156, 163, 175, 0.15); color: #9ca3af; }

    .cell-score {
        min-width: 150px;
    }

    .score-display {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .score-bar {
        flex: 1;
        height: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        overflow: hidden;
    }

    .score-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    .score-fill--green { background: #22c55e; }
    .score-fill--yellow { background: #f59e0b; }
    .score-fill--red { background: #ef4444; }

    .score-value {
        font-weight: 700;
        font-size: 0.9rem;
        min-width: 40px;
    }

    .score-value--green { color: #22c55e; }
    .score-value--yellow { color: #f59e0b; }
    .score-value--red { color: #ef4444; }

    .cell-missing {
        min-width: 200px;
    }

    .missing-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
    }

    .missing-tag {
        display: inline-block;
        padding: 2px 8px;
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border-radius: 4px;
        font-size: 0.7rem;
    }

    .missing-more {
        color: var(--text-muted);
        font-size: 0.75rem;
    }

    .complete-badge {
        display: inline-block;
        padding: 2px 8px;
        background: rgba(34, 197, 94, 0.15);
        color: #22c55e;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .table-note {
        text-align: center;
        color: var(--text-muted);
        font-size: 0.85rem;
        margin-top: 16px;
    }

    /* Buttons */
    .btn {
        display: inline-flex;
        align-items: center;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 600;
        border: none;
        cursor: pointer;
        text-decoration: none;
    }

    .btn--outline {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--text-secondary);
    }

    .btn--sm {
        padding: 6px 12px;
        font-size: 0.8rem;
    }

    @media (max-width: 1200px) {
        .stats-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (max-width: 1024px) {
        .sidebar {
            display: none;
        }
        .main-content {
            margin-left: 0;
        }
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
