---
/**
 * MDRPedia — Super Admin Dashboard
 * Modern, professional admin interface
 */
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";
import { prisma } from "../../lib/prisma";
import { requireSuperAdmin } from "../../lib/rbac";

export const prerender = false;

const request = Astro.request;

// Check if ADMIN_ACCESS_KEY is configured
const adminKeyConfigured = !!import.meta.env.ADMIN_ACCESS_KEY;

if (!adminKeyConfigured) {
    return new Response(
        `<!DOCTYPE html>
        <html>
        <head><title>Configuration Error</title></head>
        <body style="background:#0a0a12;color:#fff;font-family:system-ui;display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0">
            <div style="text-align:center;max-width:400px;padding:40px">
                <h1 style="color:#ef4444;margin-bottom:16px">Configuration Error</h1>
                <p style="color:#999;margin-bottom:24px">ADMIN_ACCESS_KEY is not set in environment variables.</p>
                <code style="background:#1a1a2e;padding:12px 20px;border-radius:8px;display:block;color:#8b5cf6;font-size:14px">
                    ADMIN_ACCESS_KEY="your-secret-key"
                </code>
                <p style="color:#666;margin-top:20px;font-size:14px">Add this to your .env file and restart the server.</p>
            </div>
        </body>
        </html>`,
        { status: 500, headers: { "Content-Type": "text/html" } },
    );
}

if (!requireSuperAdmin(request)) {
    return Astro.redirect("/login");
}

const url = new URL(request.url);
const adminKey =
    url.searchParams.get("key") || import.meta.env.ADMIN_ACCESS_KEY || "";

// Fetch all doctors
const doctors = await getCollection("doctors");
const sortedDoctors = doctors.sort(
    (a, b) => (b.data.rankingScore || 0) - (a.data.rankingScore || 0),
);

// Stats
const titanDoctors = doctors.filter((d) => d.data.tier === "TITAN");
const eliteDoctors = doctors.filter((d) => d.data.tier === "ELITE");
const masterDoctors = doctors.filter((d) => d.data.tier === "MASTER");
const historicalDoctors = doctors.filter((d) => d.data.status === "HISTORICAL");
const totalCitations = doctors.reduce(
    (acc, d) => acc + (d.data.citations?.length || 0),
    0,
);

// Top Searches
let topSearches: any[] = [];
try {
    topSearches = await prisma.searchLog.groupBy({
        by: ["queryText"],
        _count: { queryText: true },
        orderBy: { _count: { queryText: "desc" } },
        take: 10,
    });
} catch (e) {
    console.error("Analytics Error:", e);
}

// CMS Stats
let pendingEdits = 0,
    pendingProfiles = 0,
    totalPages = 0;
try {
    pendingEdits = await prisma.profileEdit.count({
        where: { status: "PENDING" },
    });
    pendingProfiles = await prisma.pendingProfile.count({
        where: { status: "PENDING" },
    });
    totalPages = await prisma.contentPage.count();
} catch (e) {
    console.error("CMS Stats Error:", e);
}
---

<Layout title="Admin Dashboard — MDRPedia" description="Restricted Access">
    <div class="admin">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar__brand">
                <div class="brand-icon">
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path d="M3 21h18M5 21V7l7-4 7 4v14M9 21v-6h6v6"></path>
                    </svg>
                </div>
                <span class="brand-text">MDRPedia</span>
                <span class="brand-badge">Admin</span>
            </div>

            <nav class="sidebar__nav">
                <a href={`/admin?key=${adminKey}`} class="nav-item active">
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <rect x="3" y="3" width="7" height="7" rx="1"></rect>
                        <rect x="14" y="3" width="7" height="7" rx="1"></rect>
                        <rect x="3" y="14" width="7" height="7" rx="1"></rect>
                        <rect x="14" y="14" width="7" height="7" rx="1"></rect>
                    </svg>
                    Dashboard
                </a>
                <a href={`/admin/doctors?key=${adminKey}`} class="nav-item">
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"
                        ></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path
                            d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"
                        ></path>
                    </svg>
                    All Doctors
                </a>
                <a href={`/admin/pages?key=${adminKey}`} class="nav-item">
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path
                            d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                        ></path>
                        <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"></path>
                    </svg>
                    CMS Pages
                </a>
                <a href={`/admin/news?key=${adminKey}`} class="nav-item">
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path
                            d="M19 20H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v1m2 13a2 2 0 0 1-2-2V7m2 13a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-2"
                        ></path>
                    </svg>
                    News
                </a>
                <a href={`/admin/claims?key=${adminKey}`} class="nav-item">
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path
                            d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
                        ></path>
                    </svg>
                    Claims
                </a>
                <a href={`/admin/edits?key=${adminKey}`} class="nav-item">
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path
                            d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                        ></path>
                        <path
                            d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                        ></path>
                    </svg>
                    Pending Edits
                </a>
                <a href={`/admin/submissions?key=${adminKey}`} class="nav-item">
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"
                        ></path>
                        <circle cx="8.5" cy="7" r="4"></circle>
                        <line x1="20" y1="8" x2="20" y2="14"></line>
                        <line x1="23" y1="11" x2="17" y2="11"></line>
                    </svg>
                    Submissions
                </a>
                <a href={`/admin/editor?key=${adminKey}`} class="nav-item">
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <circle cx="12" cy="12" r="10"></circle>
                        <circle cx="12" cy="12" r="4"></circle>
                        <path d="M12 2v4M12 18v4M2 12h4M18 12h4"></path>
                    </svg>
                    Knowledge Graph
                </a>

                <div class="nav-divider"></div>
                <span class="nav-section-label">Tools</span>

                <a href={`/admin/audit-log?key=${adminKey}`} class="nav-item">
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path
                            d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                        ></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    Activity Log
                </a>
                <a
                    href={`/admin/data-quality?key=${adminKey}`}
                    class="nav-item"
                >
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                    </svg>
                    Data Quality
                </a>
                <a href={`/admin/bulk-import?key=${adminKey}`} class="nav-item">
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
                        ></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    Bulk Import
                </a>
                <a href={`/admin/analytics?key=${adminKey}`} class="nav-item">
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path d="M18 20V10M12 20V4M6 20v-6"></path>
                    </svg>
                    Analytics
                </a>
                <a
                    href={`/admin/broken-links?key=${adminKey}`}
                    class="nav-item"
                >
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path
                            d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"
                        ></path>
                        <path
                            d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"
                        ></path>
                        <line x1="4" y1="4" x2="20" y2="20" stroke="#ef4444"
                        ></line>
                    </svg>
                    Broken Links
                </a>
            </nav>

            <div class="sidebar__footer">
                <a href="/" class="nav-item nav-item--muted">
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"
                        ></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    Exit Admin
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main">
            <!-- Mobile Header (shown when sidebar is hidden) -->
            <div class="mobile-header">
                <div class="mobile-brand">
                    <div class="brand-icon">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <path d="M3 21h18M5 21V7l7-4 7 4v14M9 21v-6h6v6"
                            ></path>
                        </svg>
                    </div>
                    <span>MDRPedia Admin</span>
                </div>
                <nav class="mobile-nav">
                    <a
                        href={`/admin?key=${adminKey}`}
                        class="mobile-nav-link active">Dashboard</a
                    >
                    <a
                        href={`/admin/doctors?key=${adminKey}`}
                        class="mobile-nav-link">Doctors</a
                    >
                    <a
                        href={`/admin/pages?key=${adminKey}`}
                        class="mobile-nav-link">Pages</a
                    >
                    <a href="/" class="mobile-nav-link">Exit</a>
                </nav>
            </div>

            <!-- Header -->
            <header class="header">
                <div class="header__title">
                    <h1>Dashboard</h1>
                    <p>Overview of MDRPedia platform</p>
                </div>
                <div class="header__actions">
                    <button id="syncCitationsBtn" class="btn btn--info">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            width="16"
                            height="16"
                        >
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                            <path
                                d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"
                            ></path>
                        </svg>
                        Sync Citations
                    </button>
                    <button id="fixDataBtn" class="btn btn--warning">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            width="16"
                            height="16"
                        >
                            <path
                                d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"
                            ></path>
                        </svg>
                        Fix Data (TSV)
                    </button>
                    <button id="enrichAllBtn" class="btn btn--success">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            width="16"
                            height="16"
                        >
                            <path
                                d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"
                            ></path>
                        </svg>
                        Enrich All (OpenAlex)
                    </button>
                    <button id="syncAllBtn" class="btn btn--primary">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            width="16"
                            height="16"
                        >
                            <path d="M23 4v6h-6M1 20v-6h6"></path>
                            <path
                                d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"
                            ></path>
                        </svg>
                        Sync PubMed
                    </button>
                </div>
            </header>

            <!-- Stats Grid -->
            <section class="stats-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card__icon stat-card__icon--purple">
                            <svg
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <path
                                    d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"
                                ></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path
                                    d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"
                                ></path>
                            </svg>
                        </div>
                        <div class="stat-card__content">
                            <span class="stat-card__value"
                                >{doctors.length}</span
                            >
                            <span class="stat-card__label">Total Profiles</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card__icon stat-card__icon--gold">
                            <svg
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <polygon
                                    points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"
                                ></polygon>
                            </svg>
                        </div>
                        <div class="stat-card__content">
                            <span class="stat-card__value"
                                >{titanDoctors.length}</span
                            >
                            <span class="stat-card__label">Titans</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card__icon stat-card__icon--blue">
                            <svg
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <circle cx="12" cy="8" r="7"></circle>
                                <polyline
                                    points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"
                                ></polyline>
                            </svg>
                        </div>
                        <div class="stat-card__content">
                            <span class="stat-card__value"
                                >{eliteDoctors.length}</span
                            >
                            <span class="stat-card__label">Elite</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card__icon stat-card__icon--green">
                            <svg
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"
                                ></path>
                                <polyline points="22 4 12 14.01 9 11.01"
                                ></polyline>
                            </svg>
                        </div>
                        <div class="stat-card__content">
                            <span class="stat-card__value"
                                >{masterDoctors.length}</span
                            >
                            <span class="stat-card__label">Master</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card__icon">
                            <svg
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"
                                ></path>
                                <path
                                    d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"
                                ></path>
                            </svg>
                        </div>
                        <div class="stat-card__content">
                            <span class="stat-card__value"
                                >{totalCitations.toLocaleString()}</span
                            >
                            <span class="stat-card__label">Citations</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card__icon">
                            <svg
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                        </div>
                        <div class="stat-card__content">
                            <span class="stat-card__value"
                                >{historicalDoctors.length}</span
                            >
                            <span class="stat-card__label">Historical</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Quick Actions & CMS -->
            <section class="actions-section">
                <h2 class="section-title">Quick Actions</h2>
                <div class="actions-grid">
                    <a
                        href={`/admin/edits?key=${adminKey}`}
                        class="action-card"
                    >
                        {
                            pendingEdits > 0 && (
                                <div class="action-card__badge action-card__badge--warning">
                                    {pendingEdits}
                                </div>
                            )
                        }
                        <div class="action-card__icon">
                            <svg
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <path
                                    d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                                ></path>
                                <path
                                    d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                                ></path>
                            </svg>
                        </div>
                        <span class="action-card__label">Pending Edits</span>
                    </a>
                    <a
                        href={`/admin/submissions?key=${adminKey}`}
                        class="action-card"
                    >
                        {
                            pendingProfiles > 0 && (
                                <div class="action-card__badge action-card__badge--info">
                                    {pendingProfiles}
                                </div>
                            )
                        }
                        <div class="action-card__icon">
                            <svg
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <path
                                    d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"
                                ></path>
                                <circle cx="8.5" cy="7" r="4"></circle>
                                <line x1="20" y1="8" x2="20" y2="14"></line>
                                <line x1="23" y1="11" x2="17" y2="11"></line>
                            </svg>
                        </div>
                        <span class="action-card__label">New Submissions</span>
                    </a>
                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    >
                    <path
                        d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                    ></path>
                    <path d="M14 2v6h6"></path>
                </div>
            </section>
            <span class="action-card__label">Content Pages</span>
        </main>
        <a href={`/admin/doctors?key=${adminKey}`} class="action-card">
            <div class="action-card__badge action-card__badge--success">
                {doctors.filter((d) => d.data.tier !== "UNRANKED").length}
            </div>
            <div class="action-card__icon">
                <svg
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                >
                    <path d="M9 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"></path>
                    <path d="M3 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    <path d="M21 21v-2a4 4 0 0 0-3-3.85"></path>
                </svg>
            </div>
            <span class="action-card__label">Verified Doctors</span>
        </a>
    </div>
</Layout>

<!-- Two Column Layout -->
<div class="two-column">
    <!-- Search Trends -->
    <section class="widget">
        <div class="widget__header">
            <h3>Search Trends</h3>
            <span class="widget__badge">Live</span>
        </div>
        <div class="widget__content">
            {
                topSearches.length > 0 ? (
                    <ul class="trend-list">
                        {topSearches.map((s, i) => (
                            <li class="trend-item">
                                <span class="trend-rank">{i + 1}</span>
                                <span class="trend-query">{s.queryText}</span>
                                <span class="trend-count">
                                    {s._count.queryText}
                                </span>
                            </li>
                        ))}
                    </ul>
                ) : (
                    <div class="empty-state">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="1.5"
                            width="32"
                            height="32"
                        >
                            <circle cx="11" cy="11" r="8" />
                            <path d="m21 21-4.3-4.3" />
                        </svg>
                        <p>No search data yet</p>
                    </div>
                )
            }
        </div>
    </section>

    <!-- Tier Override -->
    <section class="widget">
        <div class="widget__header">
            <h3>Tier Override</h3>
        </div>
        <div class="widget__content">
            <form class="tier-form" id="tierForm" novalidate>
                <div class="form-group">
                    <label for="tierSlug">Doctor Slug</label>
                    <input
                        type="text"
                        id="tierSlug"
                        placeholder="e.g., anthony-fauci"
                        required
                        pattern="[a-z0-9-]+"
                        autocomplete="off"
                    />
                    <p class="text-xs text-muted mt-1">
                        Lowercase letters and hyphens only.
                    </p>
                </div>
                <div class="form-group">
                    <label for="tierSelect">New Tier</label>
                    <select id="tierSelect">
                        <option value="TITAN">TITAN</option>
                        <option value="ELITE">ELITE</option>
                        <option value="MASTER">MASTER</option>
                        <option value="UNRANKED">UNRANKED</option>
                    </select>
                </div>
                <button type="submit" class="btn btn--primary btn--full">
                    Apply Tier Change
                </button>
            </form>
        </div>
    </section>
</div>

<!-- Recent Doctors Table -->
<section class="table-section">
    <div class="table-header">
        <h2>Recent Profiles</h2>
        <a
            href={`/admin/doctors?key=${adminKey}`}
            class="btn btn--outline btn--sm">View All</a
        >
    </div>
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Doctor</th>
                    <th>Tier</th>
                    <th>H-Index</th>
                    <th>Citations</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {
                    sortedDoctors.slice(0, 15).map((doctor) => (
                        <tr>
                            <td class="cell-doctor">
                                <a
                                    href={`/doctors/${doctor.id}`}
                                    target="_blank"
                                    class="doctor-link"
                                >
                                    <span class="doctor-name">
                                        {doctor.data.fullName}
                                    </span>
                                    <span class="doctor-specialty">
                                        {doctor.data.specialty}
                                    </span>
                                </a>
                            </td>
                            <td>
                                <span
                                    class={`tier-pill tier-pill--${doctor.data.tier.toLowerCase()}`}
                                >
                                    {doctor.data.tier}
                                </span>
                            </td>
                            <td class="cell-mono">
                                {doctor.data.hIndex || "-"}
                            </td>
                            <td class="cell-mono">
                                {doctor.data.citations?.length || 0}
                            </td>
                            <td>
                                <span
                                    class={`status-pill status-pill--${doctor.data.status.toLowerCase()}`}
                                >
                                    {doctor.data.status === "HISTORICAL"
                                        ? "Legacy"
                                        : "Active"}
                                </span>
                            </td>
                            <td>
                                <button
                                    class="btn-icon sync-btn"
                                    data-slug={doctor.id}
                                    title="Sync"
                                >
                                    <svg
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        width="14"
                                        height="14"
                                    >
                                        <path d="M23 4v6h-6M1 20v-6h6" />
                                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    ))
                }
            </tbody>
        </table>
    </div>
</section>

<!-- Sync Console Modal -->
<div class="modal" id="syncModal" hidden>
    <div
        class="modal__backdrop"
        onclick="document.getElementById('syncModal').hidden = true"
    >
    </div>
    <div class="modal__content">
        <div class="modal__header">
            <h3>Sync Console</h3>
            <button
                class="modal__close"
                onclick="document.getElementById('syncModal').hidden = true"
                >&times;</button
            >
        </div>
        <div class="modal__body">
            <div class="console" id="consoleOutput">
                <div class="console-line">Ready...</div>
            </div>
        </div>
    </div>
</div>

<script define:vars={{ adminKey }}>
    const key = adminKey;

    // Toast Notification System
    function showToast(message, type = "info") {
        const container =
            document.getElementById("toastContainer") || createToastContainer();
        const toast = document.createElement("div");
        toast.className = `toast toast--${type}`;

        const icon = type === "success" ? "✓" : type === "error" ? "✕" : "ℹ";

        toast.innerHTML = `
            <span class="toast-icon">${icon}</span>
            <span class="toast-message">${message}</span>
        `;

        container.appendChild(toast);

        // Auto remove
        setTimeout(() => {
            toast.classList.add("hiding");
            toast.addEventListener("animationend", () => toast.remove());
        }, 3000);
    }

    function createToastContainer() {
        const div = document.createElement("div");
        div.id = "toastContainer";
        div.className = "toast-container";
        document.body.appendChild(div);
        return div;
    }

    // Tier Override Form
    const tierForm = document.getElementById("tierForm");
    tierForm?.addEventListener("submit", async (e) => {
        e.preventDefault();

        const slugInput = document.getElementById("tierSlug");
        const slug = slugInput.value.trim(); // Validation: Trim whitespace
        const tier = document.getElementById("tierSelect").value;
        const btn = tierForm.querySelector("button");

        if (!slug) {
            showToast("Please enter a doctor slug", "error");
            slugInput.focus();
            return;
        }

        // Validation: Simple slug check (no spaces/special chars)
        if (!/^[a-z0-9-]+$/.test(slug)) {
            showToast(
                "Invalid slug format. Use lowercase letters and hyphens only.",
                "error",
            );
            return;
        }

        btn.disabled = true;
        btn.innerHTML = `<span class="animate-spin">...</span> Updating`;

        try {
            const res = await fetch(`/api/admin/override-tier?key=${key}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ slug, tier }),
            });
            const data = await res.json();

            if (data.success) {
                showToast(`Successfully updated ${slug} to ${tier}`, "success");
                tierForm.reset();
                // Optional: Reload after delay to show updated data
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast(data.message || "Failed to update tier", "error");
                btn.disabled = false;
                btn.textContent = "Apply Override";
            }
        } catch (err) {
            showToast("Network error occurred", "error");
            btn.disabled = false;
            btn.textContent = "Apply Override";
        }
    });

    // Sync Citations from PubMed
    document
        .getElementById("syncCitationsBtn")
        ?.addEventListener("click", async () => {
            if (
                !confirm(
                    "This will sync citations from PubMed for profiles without citations. This may take a while. Continue?",
                )
            )
                return;

            const modal = document.getElementById("syncModal");
            const output = document.getElementById("consoleOutput");
            modal.hidden = false;
            output.innerHTML =
                '<div class="console-line">Starting citation sync...</div>';

            try {
                const res = await fetch("/api/admin/populate-citations", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-admin-key": key,
                    },
                    body: JSON.stringify({ action: "sync_all", batchSize: 10 }),
                });

                const reader = res.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const text = decoder.decode(value);
                    text.split("\n")
                        .filter(Boolean)
                        .forEach((line) => {
                            try {
                                const json = JSON.parse(line);
                                const cssClass =
                                    json.type === "error"
                                        ? "console-line--error"
                                        : json.type === "success"
                                          ? "console-line--success"
                                          : json.type === "warning"
                                            ? "console-line--warning"
                                            : json.type === "complete"
                                              ? "console-line--success"
                                              : "";
                                output.innerHTML += `<div class="console-line ${cssClass}">${json.message}</div>`;
                                output.scrollTop = output.scrollHeight;
                            } catch {}
                        });
                }
            } catch (e) {
                output.innerHTML += `<div class="console-line console-line--error">Error: ${e}</div>`;
            }
        });

    // Fix Data from TSV
    document
        .getElementById("fixDataBtn")
        ?.addEventListener("click", async () => {
            if (
                !confirm(
                    "This will fix corrupted specialty/H-index data from the TSV file. Continue?",
                )
            )
                return;

            const modal = document.getElementById("syncModal");
            const output = document.getElementById("consoleOutput");
            modal.hidden = false;
            output.innerHTML =
                '<div class="console-line">Starting data fix from TSV...</div>';

            try {
                const res = await fetch("/api/admin/fix-data", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-admin-key": key,
                    },
                    body: JSON.stringify({ action: "fix_all" }),
                });

                const reader = res.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const text = decoder.decode(value);
                    text.split("\n")
                        .filter(Boolean)
                        .forEach((line) => {
                            try {
                                const json = JSON.parse(line);
                                const cssClass =
                                    json.type === "error"
                                        ? "console-line--error"
                                        : json.type === "success"
                                          ? "console-line--success"
                                          : json.type === "warning"
                                            ? "console-line--warning"
                                            : "";
                                output.innerHTML += `<div class="console-line ${cssClass}">${json.message}</div>`;
                                output.scrollTop = output.scrollHeight;
                            } catch {}
                        });
                }
            } catch (e) {
                output.innerHTML += `<div class="console-line console-line--error">Error: ${e}</div>`;
            }
        });

    // Enrich All from OpenAlex
    document
        .getElementById("enrichAllBtn")
        ?.addEventListener("click", async () => {
            if (
                !confirm(
                    "This will enrich all profiles with data from OpenAlex (H-index, publications, affiliations). This may take a while. Continue?",
                )
            )
                return;

            const modal = document.getElementById("syncModal");
            const output = document.getElementById("consoleOutput");
            modal.hidden = false;
            output.innerHTML =
                '<div class="console-line">Starting OpenAlex enrichment...</div>';

            try {
                const res = await fetch("/api/admin/enrich", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-admin-key": key,
                    },
                    body: JSON.stringify({ action: "enrich_all" }),
                });

                const reader = res.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const text = decoder.decode(value);
                    text.split("\n")
                        .filter(Boolean)
                        .forEach((line) => {
                            try {
                                const json = JSON.parse(line);
                                const cssClass =
                                    json.type === "error"
                                        ? "console-line--error"
                                        : json.type === "success"
                                          ? "console-line--success"
                                          : json.type === "warning"
                                            ? "console-line--warning"
                                            : "";
                                output.innerHTML += `<div class="console-line ${cssClass}">${json.message}</div>`;
                                output.scrollTop = output.scrollHeight;
                            } catch {}
                        });
                }
            } catch (e) {
                output.innerHTML += `<div class="console-line console-line--error">Error: ${e}</div>`;
            }
        });

    // Sync All PubMed
    document
        .getElementById("syncAllBtn")
        ?.addEventListener("click", async () => {
            if (
                !confirm(
                    "This will sync all profiles from PubMed/CrossRef. Continue?",
                )
            )
                return;

            const modal = document.getElementById("syncModal");
            const output = document.getElementById("consoleOutput");
            modal.hidden = false;
            output.innerHTML =
                '<div class="console-line">Starting PubMed sync...</div>';

            try {
                const res = await fetch("/api/admin/sync", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-admin-key": key,
                    },
                    body: JSON.stringify({ action: "sync_all" }),
                });

                const reader = res.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const text = decoder.decode(value);
                    text.split("\n")
                        .filter(Boolean)
                        .forEach((line) => {
                            try {
                                const json = JSON.parse(line);
                                const cssClass =
                                    json.type === "error"
                                        ? "console-line--error"
                                        : json.type === "success"
                                          ? "console-line--success"
                                          : json.type === "warning"
                                            ? "console-line--warning"
                                            : "";
                                output.innerHTML += `<div class="console-line ${cssClass}">${json.message}</div>`;
                                output.scrollTop = output.scrollHeight;
                            } catch {}
                        });
                }
            } catch (e) {
                output.innerHTML += `<div class="console-line console-line--error">Error: ${e}</div>`;
            }
        });

    // Single Sync
    document.querySelectorAll(".sync-btn").forEach((btn) => {
        btn.addEventListener("click", async (e) => {
            const slug = e.currentTarget.dataset.slug;
            if (!slug) return;

            const modal = document.getElementById("syncModal");
            const output = document.getElementById("consoleOutput");
            modal.hidden = false;
            output.innerHTML = `<div class="console-line">Syncing ${slug}...</div>`;

            try {
                const res = await fetch(`/api/admin/sync?key=${key}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ action: "sync_single", slug }),
                });
                const data = await res.json();
                output.innerHTML += `<div class="console-line ${data.success ? "console-line--success" : "console-line--error"}">${data.message || "Done"}</div>`;
            } catch (e) {
                output.innerHTML += `<div class="console-line console-line--error">Error: ${e}</div>`;
            }
        });
    });

    // Detect table scroll capability and show indicator
    function checkTableScroll() {
        const containers = document.querySelectorAll(".table-container");
        containers.forEach((container) => {
            const hasScroll = container.scrollWidth > container.clientWidth;
            const isScrolledToEnd =
                container.scrollLeft + container.clientWidth >=
                container.scrollWidth - 10;
            container.classList.toggle(
                "has-scroll",
                hasScroll && !isScrolledToEnd,
            );
        });
    }

    // Check on load and resize
    checkTableScroll();
    window.addEventListener("resize", checkTableScroll);

    // Update on scroll
    document.querySelectorAll(".table-container").forEach((container) => {
        container.addEventListener("scroll", checkTableScroll);
    });
</script>

<style>
    /* UI/UX Improvements */
    /* Toast Notification */
    .toast-container {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .toast {
        background: var(--bg-card);
        border: 1px solid var(--border-medium);
        padding: 16px 20px;
        border-radius: 8px;
        color: white;
        font-size: 0.9rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 300px;
        animation: slideIn 0.3s ease-out forwards;
    }

    .toast--success {
        border-left: 4px solid var(--accent-emerald);
    }
    .toast--error {
        border-left: 4px solid var(--accent-rose);
    }
    .toast--info {
        border-left: 4px solid var(--accent-blue);
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOut {
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }

    .toast.hiding {
        animation: slideOut 0.3s ease-in forwards;
    }

    /* Form Validation Feedback */
    input:invalid,
    select:invalid {
        border-color: var(--accent-rose);
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    /* Fixed Badges */
    .action-card__badge:empty {
        display: none;
    }
    .action-card__badge:not(:empty)::after {
        content: "";
    }

    /* Layout */
    .admin {
        display: flex;
        min-height: 100vh;
        background: #0a0a12;
    }

    /* Sidebar */
    .sidebar {
        width: 240px;
        background: rgba(15, 15, 25, 0.95);
        border-right: 1px solid rgba(255, 255, 255, 0.06);
        display: flex;
        flex-direction: column;
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        z-index: 50;
    }

    .sidebar__brand {
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .brand-icon {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, var(--accent-purple), #6366f1);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }

    .brand-icon svg {
        width: 18px;
        height: 18px;
    }

    .brand-text {
        font-weight: 700;
        font-size: 1rem;
        color: white;
    }

    .brand-badge {
        font-size: 0.6rem;
        font-weight: 600;
        padding: 2px 6px;
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
        border-radius: 4px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .sidebar__nav {
        flex: 1;
        padding: 16px 12px;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        border-radius: 8px;
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.15s;
    }

    .nav-item svg {
        width: 18px;
        height: 18px;
        flex-shrink: 0;
    }

    .nav-item:hover {
        background: rgba(255, 255, 255, 0.05);
        color: white;
    }

    .nav-item.active {
        background: rgba(139, 92, 246, 0.15);
        color: var(--accent-purple);
    }

    .nav-item--muted {
        color: var(--text-muted);
    }

    .nav-divider {
        height: 1px;
        background: rgba(255, 255, 255, 0.06);
        margin: 12px 0 8px;
    }

    .nav-section-label {
        display: block;
        font-size: 0.65rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        padding: 0 12px;
        margin-bottom: 8px;
    }

    .sidebar__footer {
        padding: 16px 12px;
        border-top: 1px solid rgba(255, 255, 255, 0.06);
    }

    /* Main Content */
    .main {
        flex: 1;
        margin-left: 240px;
        padding: 24px 32px;
        min-height: 100vh;
    }

    /* Header */
    .header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 32px;
    }

    .header__title h1 {
        font-size: 1.75rem;
        font-weight: 700;
        color: white;
        margin-bottom: 4px;
    }

    .header__title p {
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    /* Buttons */
    .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 18px;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.15s;
    }

    .btn--primary {
        background: linear-gradient(135deg, var(--accent-purple), #7c3aed);
        color: white;
    }

    .btn--primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }

    .btn--outline {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--text-secondary);
    }

    .btn--warning {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
    }

    .btn--warning:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }

    .btn--success {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }

    .btn--success:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .btn--info {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
    }

    .btn--info:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn--outline:hover {
        border-color: rgba(255, 255, 255, 0.2);
        color: white;
    }

    .btn--sm {
        padding: 6px 12px;
        font-size: 0.8rem;
    }

    .btn--full {
        width: 100%;
        justify-content: center;
    }

    .btn-icon {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: var(--text-muted);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.15s;
    }

    .btn-icon:hover {
        background: rgba(139, 92, 246, 0.15);
        border-color: rgba(139, 92, 246, 0.3);
        color: var(--accent-purple);
    }

    /* Stats Section */
    .stats-section {
        margin-bottom: 32px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 16px;
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 12px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .stat-card__icon {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.05);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
    }

    .stat-card__icon svg {
        width: 20px;
        height: 20px;
    }

    .stat-card__icon--purple {
        background: rgba(139, 92, 246, 0.15);
        color: var(--accent-purple);
    }

    .stat-card__icon--gold {
        background: rgba(255, 215, 0, 0.12);
        color: #ffd700;
    }

    .stat-card__icon--blue {
        background: rgba(0, 170, 255, 0.12);
        color: #00aaff;
    }

    .stat-card__icon--green {
        background: rgba(0, 204, 102, 0.12);
        color: #00cc66;
    }

    .stat-card__content {
        display: flex;
        flex-direction: column;
    }

    .stat-card__value {
        font-size: 1.5rem;
        font-weight: 700;
        color: white;
        line-height: 1.2;
    }

    .stat-card__label {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* Actions Section */
    .actions-section {
        margin-bottom: 32px;
    }

    .section-title {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 16px;
    }

    .actions-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
    }

    .action-card {
        position: relative;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 12px;
        padding: 20px;
        text-decoration: none;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        transition: all 0.2s;
    }

    .action-card:hover {
        background: rgba(255, 255, 255, 0.04);
        border-color: rgba(255, 255, 255, 0.1);
        transform: translateY(-2px);
    }

    .action-card__badge {
        position: absolute;
        top: 12px;
        right: 12px;
        font-size: 0.7rem;
        font-weight: 700;
        padding: 2px 8px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-secondary);
    }

    .action-card__badge--warning {
        background: rgba(245, 158, 11, 0.15);
        color: #f59e0b;
    }

    .action-card__badge--info {
        background: rgba(59, 130, 246, 0.15);
        color: #3b82f6;
    }

    .action-card__badge--success {
        background: rgba(34, 197, 94, 0.15);
        color: #22c55e;
    }

    .action-card__icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.05);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
    }

    .action-card__icon svg {
        width: 24px;
        height: 24px;
    }

    .action-card__label {
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--text-secondary);
    }

    /* Two Column */
    .two-column {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        margin-bottom: 32px;
    }

    /* Widget */
    .widget {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 12px;
        overflow: hidden;
    }

    .widget__header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .widget__header h3 {
        font-size: 0.95rem;
        font-weight: 600;
        color: white;
    }

    .widget__badge {
        font-size: 0.65rem;
        font-weight: 600;
        padding: 3px 8px;
        background: rgba(34, 197, 94, 0.15);
        color: #22c55e;
        border-radius: 10px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .widget__content {
        padding: 16px 20px;
    }

    /* Trend List */
    .trend-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .trend-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
    }

    .trend-item:last-child {
        border-bottom: none;
    }

    .trend-rank {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.05);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted);
    }

    .trend-query {
        flex: 1;
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    .trend-count {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--accent-purple);
        font-family: var(--font-mono, monospace);
    }

    /* Form */
    .tier-form {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .form-group label {
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--text-muted);
    }

    .form-group input,
    .form-group select {
        padding: 10px 14px;
        border-radius: 8px;
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
        font-size: 0.9rem;
        outline: none;
        transition: border-color 0.15s;
    }

    .form-group input:focus,
    .form-group select:focus {
        border-color: var(--accent-purple);
    }

    .form-group input::placeholder {
        color: var(--text-muted);
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 32px 16px;
        color: var(--text-muted);
    }

    .empty-state svg {
        margin-bottom: 12px;
        opacity: 0.5;
    }

    .empty-state p {
        font-size: 0.9rem;
    }

    /* Table Section */
    .table-section {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 12px;
        overflow: hidden;
    }

    .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .table-header h2 {
        font-size: 0.95rem;
        font-weight: 600;
        color: white;
    }

    .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        position: relative;
    }

    /* Scroll indicator gradient */
    .table-container::after {
        content: "";
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 40px;
        background: linear-gradient(
            to right,
            transparent,
            rgba(10, 10, 18, 0.9)
        );
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .table-container.has-scroll::after {
        opacity: 1;
    }

    .table-container::-webkit-scrollbar {
        height: 6px;
    }

    .table-container::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 3px;
    }

    .table-container::-webkit-scrollbar-thumb {
        background: rgba(139, 92, 246, 0.4);
        border-radius: 3px;
    }

    .table-container::-webkit-scrollbar-thumb:hover {
        background: rgba(139, 92, 246, 0.6);
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 700px;
    }

    .data-table th {
        text-align: left;
        padding: 12px 16px;
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        background: rgba(0, 0, 0, 0.2);
    }

    .data-table td {
        padding: 12px 16px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        vertical-align: middle;
    }

    .cell-doctor {
        min-width: 200px;
    }

    .doctor-link {
        display: flex;
        flex-direction: column;
        gap: 2px;
        text-decoration: none;
    }

    .doctor-name {
        font-weight: 600;
        color: white;
        font-size: 0.9rem;
    }

    .doctor-link:hover .doctor-name {
        color: var(--accent-purple);
    }

    .doctor-specialty {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .cell-mono {
        font-family: var(--font-mono, monospace);
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    /* Pills */
    .tier-pill {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }

    .tier-pill--titan {
        background: rgba(255, 215, 0, 0.12);
        color: #ffd700;
    }

    .tier-pill--elite {
        background: rgba(0, 170, 255, 0.12);
        color: #00aaff;
    }

    .tier-pill--master {
        background: rgba(0, 204, 102, 0.12);
        color: #00cc66;
    }

    .tier-pill--unranked {
        background: rgba(255, 255, 255, 0.06);
        color: var(--text-muted);
    }

    .status-pill {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 600;
    }

    .status-pill--living {
        background: rgba(34, 197, 94, 0.12);
        color: #22c55e;
    }

    .status-pill--historical {
        background: rgba(156, 163, 175, 0.12);
        color: #9ca3af;
    }

    /* Modal */
    .modal {
        position: fixed;
        inset: 0;
        z-index: 100;
        display: none;
        align-items: center;
        justify-content: center;
    }

    .modal:not([hidden]) {
        display: flex;
    }

    .modal__backdrop {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
    }

    .modal__content {
        position: relative;
        width: 90%;
        max-width: 600px;
        background: #16162a;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        overflow: hidden;
    }

    .modal__header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .modal__header h3 {
        font-size: 1rem;
        font-weight: 600;
        color: white;
    }

    .modal__close {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: transparent;
        border: none;
        color: var(--text-muted);
        font-size: 1.5rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal__close:hover {
        color: white;
        background: rgba(255, 255, 255, 0.05);
    }

    .modal__body {
        padding: 20px;
    }

    /* Console */
    .console {
        background: #000;
        border-radius: 8px;
        padding: 16px;
        font-family: var(--font-mono, monospace);
        font-size: 0.85rem;
        max-height: 300px;
        overflow-y: auto;
    }

    .console-line {
        color: #888;
        margin-bottom: 4px;
    }

    .console-line--success {
        color: #22c55e;
    }

    .console-line--error {
        color: #ef4444;
    }

    .console-line--warning {
        color: #f59e0b;
    }

    /* Mobile Header */
    .mobile-header {
        display: none;
        flex-direction: column;
        gap: 16px;
        padding: 16px 0;
        margin-bottom: 16px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .mobile-brand {
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 700;
        color: white;
    }

    .mobile-brand .brand-icon {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, var(--accent-purple), #6366f1);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }

    .mobile-brand .brand-icon svg {
        width: 18px;
        height: 18px;
    }

    .mobile-nav {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .mobile-nav-link {
        padding: 8px 14px;
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--text-secondary);
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 8px;
        text-decoration: none;
        transition: all 0.15s;
    }

    .mobile-nav-link:hover {
        background: rgba(255, 255, 255, 0.08);
        color: white;
    }

    .mobile-nav-link.active {
        background: rgba(139, 92, 246, 0.15);
        border-color: rgba(139, 92, 246, 0.3);
        color: var(--accent-purple);
    }

    /* Responsive */
    @media (max-width: 1200px) {
        .stats-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (max-width: 1024px) {
        .sidebar {
            display: none;
        }
        .main {
            margin-left: 0;
        }
        .mobile-header {
            display: flex;
        }
        .actions-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .main {
            padding: 16px;
        }
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        .two-column {
            grid-template-columns: 1fr;
        }
        .actions-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
