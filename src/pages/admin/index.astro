---
/**
 * MDRPedia ‚Äî Super Admin Dashboard
 * Simple protected dashboard to view doctor status and trigger data sync.
 */
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";

import { PrismaClient } from "@prisma/client";
import { requireSuperAdmin } from "../../lib/rbac";

export const prerender = false;

const request = Astro.request;
if (!requireSuperAdmin(request)) {
    return new Response(
        "Unauthorized Access. Please provide ?key=... or header.",
        { status: 401 },
    );
}

// Extract key for client-side usage
const url = new URL(request.url);
const adminKey = url.searchParams.get("key") || "mdr2026"; // Default or extracted

const prisma = new PrismaClient();

// Fetch all doctors for display
const doctors = await getCollection("doctors");
const sortedDoctors = doctors.sort(
    (a, b) => (b.data.rankingScore || 0) - (a.data.rankingScore || 0),
);

// Prisma: Fetch Top Searches
let topSearches: { queryText: string; _count: { queryText: number } }[] = [];
try {
    topSearches = await prisma.searchLog.groupBy({
        by: ["queryText"],
        _count: { queryText: true },
        orderBy: { _count: { queryText: "desc" } },
        take: 8,
    });
} catch (e) {
    console.error("Analytics Error:", e);
}

// Basic stats
const totalDoctors = doctors.length;
const verifiedCount = doctors.filter((d) => d.data.tier !== "UNRANKED").length;
const totalCitations = doctors.reduce(
    (acc, d) => acc + (d.data.citations?.length || 0),
    0,
);
---

<Layout title="Super Admin ‚Äî MDRPedia" description="Restricted Access">
    <div class="container admin-dashboard">
        <header class="admin-header">
            <div class="admin-header__top">
                <span class="badge badge--admin">SUPER ADMIN</span>
                <h1>Global Authority Engine</h1>
            </div>
            <div class="admin-actions">
                <button id="syncAllBtn" class="btn btn--primary">
                    üîÑ Deep-Sync All Profiles
                </button>
            </div>
        </header>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-card__val">{totalDoctors}</span>
                <span class="stat-card__label">Total Profiles</span>
            </div>
            <div class="stat-card">
                <span class="stat-card__val">{verifiedCount}</span>
                <span class="stat-card__label">Verified (Tiered)</span>
            </div>
            <div class="stat-card">
                <span class="stat-card__val"
                    >{totalCitations.toLocaleString()}</span
                >
                <span class="stat-card__label">Total Citations</span>
            </div>
            <div class="stat-card">
                <span class="stat-card__val"
                    >{
                        doctors.filter((d) => d.data.status === "HISTORICAL")
                            .length
                    }</span
                >
                <span class="stat-card__label">Historical</span>
            </div>
        </div>

        <div class="dashboard-layout">
            <div class="dashboard-column">
                <!-- System Sovereignty -->
                <div class="widget-card">
                    <h3>üëë System Sovereignty</h3>
                    <div class="control-row">
                        <span class="label">Global Ingestion</span>
                        <label class="toggle-switch">
                            <input type="checkbox" checked />
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="control-group">
                        <div class="flex-between">
                            <span class="label">API Credits (OpenAlex)</span>
                            <span class="value success">45,200 / 50,000</span>
                        </div>
                        <div class="progress-bar">
                            <div class="fill" style="width: 90%;"></div>
                        </div>
                    </div>
                    <div class="control-row">
                        <span class="label">Google Indexing</span>
                        <button class="btn btn--sm btn--outline"
                            >Trigger Sitemap</button
                        >
                    </div>
                </div>

                <!-- Tier Override -->
                <div class="widget-card">
                    <h3>‚ö° Tier Override</h3>
                    <form
                        class="tier-form"
                        onsubmit="event.preventDefault(); alert('Tier Override: Functionality Coming Soon');"
                    >
                        <input
                            type="text"
                            placeholder="Doctor Slug (e.g. anthony-fauci)"
                            class="input-sm"
                        />
                        <select class="select-sm">
                            <option value="TITAN">TITAN (0.01%)</option>
                            <option value="ELITE">ELITE (1%)</option>
                            <option value="MASTER">MASTER (3%)</option>
                        </select>
                        <button class="btn btn--sm btn--primary"
                            >Set Tier</button
                        >
                    </form>
                </div>

                <!-- Editor Workspace Link -->
                <div class="widget-card" style="margin-top: var(--space-lg);">
                    <h3>üß¨ Knowledge Graph</h3>
                    <p
                        style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 12px;"
                    >
                        Manage relationships and lineage.
                    </p>
                    <a
                        href="/admin/editor"
                        class="btn btn--sm btn--outline"
                        style="text-decoration: none; display: inline-block;"
                    >
                        Open Workspace
                    </a>
                </div>
            </div>

            <div class="dashboard-column">
                <!-- Search Trends Widget -->
                <div class="widget-card">
                    <h3>üî• Search Trends</h3>
                    <ul class="trend-list">
                        {
                            topSearches.length > 0 ? (
                                topSearches.map((s) => (
                                    <li class="trend-item">
                                        <span class="trend-query">
                                            {s.queryText}
                                        </span>
                                        <span class="trend-count">
                                            {s._count.queryText}
                                        </span>
                                    </li>
                                ))
                            ) : (
                                <li class="trend-empty">No search data yet.</li>
                            )
                        }
                    </ul>
                </div>
            </div>
        </div>

        <!-- Audit Logs -->
        <div class="widget-card" style="margin-bottom: var(--space-xl);">
            <h3>üõ°Ô∏è Security Audit Log</h3>
            <div
                class="table-container"
                style="max-height: 300px; overflow-y: auto;"
            >
                <table class="admin-table" id="auditLogTable">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Action</th>
                            <th>Target</th>
                            <th>Admin</th>
                            <th>IP</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr
                            ><td
                                colspan="5"
                                style="text-align:center; color:#666;"
                                >Loading logs...</td
                            ></tr
                        >
                    </tbody>
                </table>
            </div>
        </div>

        <script>
            // Fetch Logs
            async function fetchLogs() {
                try {
                    const res = await fetch(`/api/admin/logs?key=${adminKey}`);
                    if (!res.ok) throw new Error("Unauth");
                    const logs = await res.json();

                    const tbody = document.querySelector(
                        "#auditLogTable tbody",
                    );
                    if (tbody) {
                        tbody.innerHTML = logs
                            .map(
                                (log: any) => `
                            <tr>
                                <td style="color:#888; font-size:0.8em;">${new Date(log.timestamp).toLocaleString()}</td>
                                <td style="font-weight:bold; color:var(--accent-purple);">${log.action}</td>
                                <td>${log.target || "-"}</td>
                                <td>${log.adminId}</td>
                                <td style="font-family:monospace; color:#666;">${log.ipAddress || "unknown"}</td>
                            </tr>
                        `,
                            )
                            .join("");
                    }
                } catch (e) {
                    console.error("Failed to fetch logs", e);
                }
            }
            // Fetch on load
            fetchLogs();
        </script>

        <!-- Sync Log Console -->
        <div class="console-window" id="consoleWindow" style="display: none;">
            <div class="console-header">
                <span>System Log</span>
                <button class="console-close" id="consoleClose">√ó</button>
            </div>
            <div class="console-body" id="consoleBody">
                <div class="log-line">Ready...</div>
            </div>
        </div>

        <!-- Doctors Table -->
        <div class="table-container">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Doctor</th>
                        <th>Tier</th>
                        <th>Score</th>
                        <th>H-Index</th>
                        <th>Citations</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {
                        sortedDoctors.map((doctor) => (
                            <tr>
                                <td class="col-name">
                                    <a
                                        href={`/doctors/${doctor.id}`}
                                        target="_blank"
                                        class="doctor-link"
                                    >
                                        {doctor.data.fullName}
                                    </a>
                                    <span class="sub-text">
                                        {doctor.data.specialty}
                                    </span>
                                </td>
                                <td>
                                    <span
                                        class={`tier-badge tier-${doctor.data.tier.toLowerCase()}`}
                                    >
                                        {doctor.data.tier}
                                    </span>
                                </td>
                                <td class="font-mono">
                                    {doctor.data.rankingScore || "-"}
                                </td>
                                <td class="font-mono">{doctor.data.hIndex}</td>
                                <td class="font-mono">
                                    {doctor.data.citations?.length || 0}
                                </td>
                                <td>
                                    <span
                                        class={`status-dot status-${doctor.data.status.toLowerCase()}`}
                                    />
                                    {doctor.data.status}
                                </td>
                                <td>
                                    <button
                                        class="btn-icon sync-single-btn"
                                        data-slug={doctor.id}
                                        title="Sync this profile"
                                    >
                                        üîÑ
                                    </button>
                                </td>
                            </tr>
                        ))
                    }
                </tbody>
            </table>
        </div>
    </div>
</Layout>

<script define:vars={{ adminKey }}>
    // Simple client-side auth check
    console.log("Admin Dashboard Loaded", adminKey);
    // Removed prompt, relying on server-side 401
    
    // Sync Logic
        const input = prompt("Enter Admin Access Key:");
        if (input !== "mdr2026") {
            alert("Access Denied");
            window.location.href = "/";
        }
    }

    // Sync Logic
    const consoleWindow = document.getElementById("consoleWindow");
    const consoleBody = document.getElementById("consoleBody");
    const syncAllBtn = document.getElementById("syncAllBtn");

    function log(msg: string, type = "info") {
        if (!consoleBody) return;
        const line = document.createElement("div");
        line.className = `log-line log-${type}`;
        line.textContent = `> ${msg}`;
        consoleBody.appendChild(line);
        consoleBody.scrollTop = consoleBody.scrollHeight;
    }

    // Sync All
    syncAllBtn?.addEventListener("click", async () => {
        // ... (existing sync logic) ...
        if (
            !confirm(
                "This will fetch live data from PubMed/CrossRef for ALL doctors. This may take a few minutes. Continue?",
            )
        )
            return;
        // ...
        try {
            const res = await fetch("/api/admin/sync", {
                method: "POST",
                headers: { "Content-Type": "application/json", "x-admin-key": adminKey },
                body: JSON.stringify({ action: "sync_all" }),
            });
            // ... (rest of sync logic)
        } catch (e) {}
    });

    // Ingestion Toggle Logic
    const ingestionToggle = document.querySelector(".toggle-switch input");
    ingestionToggle?.addEventListener("change", async (e) => {
        const enabled = (e.target as HTMLInputElement).checked;
        try {
            const res = await fetch(`/api/admin/config?key=${adminKey}`, { // Pass key in URL or header
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ ingestionEnabled: enabled }),
            });
            const data = await res.json();
            alert(data.message);
        } catch (err) {
            alert("Failed to update config");
        }
    });

    // Tier Override Logic
    const tierForm = document.querySelector(".tier-form");
    tierForm?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const slug = (tierForm.querySelector("input") as HTMLInputElement)
            .value;
        const tier = (tierForm.querySelector("select") as HTMLSelectElement)
            .value;

        if (!slug) return alert("Enter a slug");

        try {
            const res = await fetch(`/api/admin/override-tier?key=${adminKey}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ slug, tier }),
            });
            const data = await res.json();
            alert(data.message);
            if (data.success) location.reload();
        } catch (err) {
            alert("Override failed");
        }
    });

    // Sync Single
    document.querySelectorAll(".sync-single-btn").forEach((btn) => {
        btn.addEventListener("click", async (e) => {
            const slug = (e.currentTarget as HTMLButtonElement).dataset.slug;
            if (!slug) return;

            consoleWindow!.style.display = "block";
            log(`Syncing ${slug}...`, "info");

            try {
                const res = await fetch(`/api/admin/sync?key=${adminKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ action: "sync_single", slug }),
                });
                const data = await res.json();
                console.log(data); // Log full response for debugging
                log(
                    data.message || "Sync finished",
                    data.success ? "success" : "error",
                );
            } catch (e) {
                log(`Error: ${e}`, "error");
            }
        });
    });

    document.getElementById("consoleClose")?.addEventListener("click", () => {
        consoleWindow!.style.display = "none";
        consoleBody!.innerHTML = "";
    });
</script>

<style>
    .admin-dashboard {
        padding: var(--space-2xl) 0;
        min-height: 80vh;
    }

    .admin-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        margin-bottom: var(--space-xl);
        padding-bottom: var(--space-md);
        border-bottom: 1px solid var(--border-subtle);
    }

    .badge--admin {
        background: #ff0000;
        color: white;
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 4px;
        vertical-align: middle;
        margin-right: 8px;
    }

    .admin-header h1 {
        font-size: 1.8rem;
        display: inline-block;
        margin: 0;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--space-md);
        margin-bottom: var(--space-xl);
    }

    .dashboard-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-lg);
        margin-bottom: var(--space-xl);
    }

    @media (max-width: 768px) {
        .dashboard-layout {
            grid-template-columns: 1fr;
        }
    }

    .widget-card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        padding: var(--space-lg);
        border-radius: var(--radius-lg);
        height: 100%;
    }
    .control-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-md);
        padding-bottom: var(--space-sm);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    .control-group {
        margin-bottom: var(--space-md);
    }
    .label {
        font-size: 0.85rem;
        color: var(--text-secondary);
    }
    .value {
        font-family: monospace;
        font-weight: bold;
    }
    .success {
        color: #00cc66;
    }

    .progress-bar {
        height: 6px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        margin-top: 8px;
        overflow: hidden;
    }
    .fill {
        background: #00cc66;
        height: 100%;
    }

    /* Inputs */
    .input-sm,
    .select-sm {
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid var(--border-subtle);
        color: white;
        padding: 6px 10px;
        border-radius: 4px;
        font-size: 0.85rem;
        width: 100%;
        margin-bottom: 8px;
    }
    .tier-form {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    /* Toggle Switch */
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 40px;
        height: 20px;
    }
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #333;
        transition: 0.4s;
        border-radius: 20px;
    }
    .slider:before {
        position: absolute;
        content: "";
        height: 14px;
        width: 14px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
    }
    input:checked + .slider {
        background-color: var(--accent-purple);
    }
    input:checked + .slider:before {
        transform: translateX(20px);
    }

    .flex-between {
        display: flex;
        justify-content: space-between;
    }
    .btn--sm {
        padding: 4px 10px;
        font-size: 0.8rem;
    }
    .btn--outline {
        background: transparent;
        border: 1px solid var(--border-subtle);
        color: var(--text-secondary);
    }
    .btn--outline:hover {
        border-color: white;
        color: white;
    }

    .widget-card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        padding: var(--space-lg);
        border-radius: var(--radius-lg);
    }
    .widget-card h3 {
        font-size: 1rem;
        margin-bottom: var(--space-md);
        color: var(--text-primary);
        border-bottom: 1px solid var(--border-subtle);
        padding-bottom: var(--space-sm);
    }
    .trend-list {
        list-style: none;
        padding: 0;
    }
    .trend-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        font-size: 0.9rem;
    }
    .trend-query {
        color: var(--text-secondary);
    }
    .trend-count {
        font-weight: bold;
        color: var(--accent-purple);
        font-family: monospace;
    }
    .trend-empty {
        color: var(--text-muted);
        font-style: italic;
    }

    .stat-card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        padding: var(--space-md);
        border-radius: var(--radius-md);
        text-align: center;
    }

    .stat-card__val {
        display: block;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .stat-card__label {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
    }

    .table-container {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        overflow-x: auto;
    }

    .admin-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }

    .admin-table th {
        text-align: left;
        padding: var(--space-md);
        border-bottom: 1px solid var(--border-subtle);
        color: var(--text-muted);
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
    }

    .admin-table td {
        padding: var(--space-md);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        vertical-align: middle;
    }

    .col-name {
        display: flex;
        flex-direction: column;
    }

    .doctor-link {
        font-weight: 600;
        color: var(--text-primary);
        text-decoration: none;
    }
    .doctor-link:hover {
        text-decoration: underline;
    }

    .sub-text {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .tier-badge {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
    }
    .tier-titan {
        background: rgba(255, 215, 0, 0.1);
        color: #ffd700;
        border: 1px solid rgba(255, 215, 0, 0.3);
    }
    .tier-elite {
        background: rgba(0, 170, 255, 0.1);
        color: #00aaff;
        border: 1px solid rgba(0, 170, 255, 0.3);
    }
    .tier-master {
        background: rgba(0, 204, 102, 0.1);
        color: #00cc66;
        border: 1px solid rgba(0, 204, 102, 0.3);
    }
    .tier-unranked {
        background: rgba(255, 255, 255, 0.05);
        color: #888;
    }

    .font-mono {
        font-family: monospace;
        opacity: 0.9;
    }

    .btn {
        padding: 8px 16px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.2s;
    }
    .btn--primary {
        background: var(--accent-purple);
        color: white;
    }
    .btn--primary:hover {
        background: var(--accent-purple-light);
    }

    .btn-icon {
        background: transparent;
        border: 1px solid var(--border-subtle);
        color: var(--text-muted);
        width: 32px;
        height: 32px;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .btn-icon:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
    }

    /* Console Window */
    .console-window {
        background: #000;
        border: 1px solid #333;
        border-radius: 8px;
        margin-bottom: var(--space-lg);
        font-family: monospace;
        overflow: hidden;
    }
    .console-header {
        background: #222;
        padding: 8px 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.8rem;
        color: #aaa;
    }
    .console-close {
        background: none;
        border: none;
        color: #fff;
        cursor: pointer;
        font-size: 1.2rem;
    }
    .console-body {
        height: 200px;
        overflow-y: auto;
        padding: 12px;
        color: #0f0;
        font-size: 0.85rem;
    }
    .log-line {
        margin-bottom: 4px;
    }
    .log-error {
        color: #ff5555;
    }
    .log-success {
        color: #55ff55;
    }
    .log-info {
        color: #aaa;
    }
</style>
