---
/**
 * MDRPedia — Knowledge Graph Editor
 * Visual interface for managing medical knowledge relationships
 */
import Layout from "../../layouts/Layout.astro";
import LineageMapper from "../../components/LineageMapper";
import { requireSuperAdmin } from "../../lib/rbac";
import { prisma } from "../../lib/prisma";

export const prerender = false;

if (!requireSuperAdmin(Astro.request)) {
    return Astro.redirect("/login");
}

const adminKey = new URL(Astro.request.url).searchParams.get("key") || "";

// Get relationship stats
let lineageCount = 0;
let mentorCount = 0;
let studentCount = 0;

try {
    // Count lineage relationships
    const lineages = await prisma.mentorship.count();
    lineageCount = lineages;

    // Count unique mentors
    const mentors = await prisma.mentorship.groupBy({
        by: ['mentor_id'],
        _count: true
    });
    mentorCount = mentors.length;

    // Count unique students
    const students = await prisma.mentorship.groupBy({
        by: ['student_id'],
        _count: true
    });
    studentCount = students.length;
} catch (e) {
    console.error('Failed to fetch lineage stats:', e);
}

// Get recent lineages
let recentLineages: any[] = [];
try {
    recentLineages = await prisma.mentorship.findMany({
        take: 10,
        orderBy: { createdAt: 'desc' },
        include: {
            mentor: {
                select: { full_name: true, slug: true, specialty: true }
            },
            student: {
                select: { full_name: true, slug: true, specialty: true }
            }
        }
    });
} catch (e) {
    console.error('Failed to fetch recent lineages:', e);
}
---

<Layout title="Knowledge Graph Editor — MDRPedia">
    <div class="editor-page">
        <!-- Header -->
        <header class="editor-header">
            <div class="editor-header__left">
                <a href={`/admin?key=${adminKey}`} class="back-link">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Back to Dashboard
                </a>
                <h1>Knowledge Graph Editor</h1>
                <p class="subtitle">Manage mentorship lineages and academic relationships</p>
            </div>
        </header>

        <!-- Stats Cards -->
        <section class="stats-row">
            <div class="stat-card">
                <div class="stat-card__icon stat-card__icon--purple">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="5" r="3"/>
                        <circle cx="5" cy="19" r="3"/>
                        <circle cx="19" cy="19" r="3"/>
                        <path d="M12 8v4M8.5 16.5l2-2M15.5 16.5l-2-2"/>
                    </svg>
                </div>
                <div class="stat-card__content">
                    <span class="stat-card__value">{lineageCount}</span>
                    <span class="stat-card__label">Total Lineages</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-card__icon stat-card__icon--blue">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                </div>
                <div class="stat-card__content">
                    <span class="stat-card__value">{mentorCount}</span>
                    <span class="stat-card__label">Unique Mentors</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-card__icon stat-card__icon--green">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="8.5" cy="7" r="4"/>
                        <line x1="20" y1="8" x2="20" y2="14"/>
                        <line x1="23" y1="11" x2="17" y2="11"/>
                    </svg>
                </div>
                <div class="stat-card__content">
                    <span class="stat-card__value">{studentCount}</span>
                    <span class="stat-card__label">Unique Students</span>
                </div>
            </div>
        </section>

        <!-- Main Content Grid -->
        <div class="editor-grid">
            <!-- Lineage Mapper -->
            <section class="editor-section">
                <div class="section-header">
                    <h2>Create Lineage Link</h2>
                    <span class="badge badge--info">Interactive</span>
                </div>
                <div class="section-content">
                    <LineageMapper client:load />
                </div>
            </section>

            <!-- Quick Actions -->
            <section class="editor-section">
                <div class="section-header">
                    <h2>Quick Actions</h2>
                </div>
                <div class="section-content">
                    <div class="quick-actions">
                        <a href={`/admin/claims?key=${adminKey}`} class="action-btn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                            </svg>
                            Review Profile Claims
                        </a>
                        <a href={`/admin/doctors?key=${adminKey}`} class="action-btn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                            Manage Doctors
                        </a>
                        <a href={`/admin/edits?key=${adminKey}`} class="action-btn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                            Pending Edits
                        </a>
                        <a href={`/admin/submissions?key=${adminKey}`} class="action-btn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="8.5" cy="7" r="4"/>
                                <line x1="20" y1="8" x2="20" y2="14"/>
                                <line x1="23" y1="11" x2="17" y2="11"/>
                            </svg>
                            New Submissions
                        </a>
                    </div>
                </div>
            </section>
        </div>

        <!-- Recent Lineages Table -->
        <section class="editor-section editor-section--full">
            <div class="section-header">
                <h2>Recent Lineage Links</h2>
                <span class="badge badge--neutral">{recentLineages.length} shown</span>
            </div>
            <div class="section-content">
                {recentLineages.length > 0 ? (
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Mentor</th>
                                <th>Relationship</th>
                                <th>Student</th>
                                <th>Created</th>
                            </tr>
                        </thead>
                        <tbody>
                            {recentLineages.map((lineage) => (
                                <tr>
                                    <td>
                                        <a href={`/doctors/${lineage.mentor?.slug}`} target="_blank" class="doctor-link">
                                            <span class="doctor-name">{lineage.mentor?.full_name || 'Unknown'}</span>
                                            <span class="doctor-specialty">{lineage.mentor?.specialty || '-'}</span>
                                        </a>
                                    </td>
                                    <td>
                                        <div class="relationship-arrow">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                                <path d="M5 12h14M12 5l7 7-7 7"/>
                                            </svg>
                                        </div>
                                    </td>
                                    <td>
                                        <a href={`/doctors/${lineage.student?.slug}`} target="_blank" class="doctor-link">
                                            <span class="doctor-name">{lineage.student?.full_name || 'Unknown'}</span>
                                            <span class="doctor-specialty">{lineage.student?.specialty || '-'}</span>
                                        </a>
                                    </td>
                                    <td class="cell-date">
                                        {new Date(lineage.createdAt).toLocaleDateString('en-US', {
                                            month: 'short',
                                            day: 'numeric',
                                            year: 'numeric'
                                        })}
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                ) : (
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48">
                            <circle cx="12" cy="5" r="3"/>
                            <circle cx="5" cy="19" r="3"/>
                            <circle cx="19" cy="19" r="3"/>
                            <path d="M12 8v4M8.5 16.5l2-2M15.5 16.5l-2-2"/>
                        </svg>
                        <h3>No Lineage Links Yet</h3>
                        <p>Use the Lineage Mapper above to create mentor-student relationships.</p>
                    </div>
                )}
            </div>
        </section>
    </div>
</Layout>

<style>
    .editor-page {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 24px;
    }

    /* Header */
    .editor-header {
        margin-bottom: 32px;
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        color: var(--text-muted);
        text-decoration: none;
        font-size: 0.85rem;
        margin-bottom: 12px;
        transition: color 0.15s;
    }

    .back-link:hover {
        color: var(--accent-purple);
    }

    .editor-header h1 {
        font-size: 2rem;
        font-weight: 700;
        color: white;
        margin-bottom: 8px;
    }

    .subtitle {
        color: var(--text-muted);
        font-size: 1rem;
    }

    /* Stats Row */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        margin-bottom: 32px;
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 12px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .stat-card__icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.05);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
    }

    .stat-card__icon svg {
        width: 24px;
        height: 24px;
    }

    .stat-card__icon--purple {
        background: rgba(139, 92, 246, 0.15);
        color: var(--accent-purple);
    }

    .stat-card__icon--blue {
        background: rgba(59, 130, 246, 0.15);
        color: #3b82f6;
    }

    .stat-card__icon--green {
        background: rgba(16, 185, 129, 0.15);
        color: #10b981;
    }

    .stat-card__content {
        display: flex;
        flex-direction: column;
    }

    .stat-card__value {
        font-size: 1.5rem;
        font-weight: 700;
        color: white;
    }

    .stat-card__label {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* Editor Grid */
    .editor-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 24px;
        margin-bottom: 32px;
    }

    /* Editor Sections */
    .editor-section {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 16px;
        overflow: hidden;
    }

    .editor-section--full {
        grid-column: 1 / -1;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .section-header h2 {
        font-size: 1rem;
        font-weight: 600;
        color: white;
    }

    .section-content {
        padding: 20px;
    }

    /* Badges */
    .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .badge--info {
        background: rgba(59, 130, 246, 0.15);
        color: #3b82f6;
    }

    .badge--neutral {
        background: rgba(255, 255, 255, 0.08);
        color: var(--text-muted);
    }

    /* Quick Actions */
    .quick-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .action-btn {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 16px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 10px;
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.15s;
    }

    .action-btn svg {
        width: 18px;
        height: 18px;
        flex-shrink: 0;
    }

    .action-btn:hover {
        background: rgba(139, 92, 246, 0.1);
        border-color: rgba(139, 92, 246, 0.3);
        color: var(--accent-purple);
    }

    /* Table */
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th {
        text-align: left;
        padding: 12px 16px;
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        background: rgba(0, 0, 0, 0.2);
    }

    .data-table td {
        padding: 14px 16px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        vertical-align: middle;
    }

    .doctor-link {
        display: flex;
        flex-direction: column;
        gap: 2px;
        text-decoration: none;
    }

    .doctor-name {
        font-weight: 600;
        color: white;
        font-size: 0.9rem;
    }

    .doctor-link:hover .doctor-name {
        color: var(--accent-purple);
    }

    .doctor-specialty {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .relationship-arrow {
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--accent-purple);
    }

    .cell-date {
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 48px 20px;
        color: var(--text-muted);
    }

    .empty-state svg {
        margin-bottom: 16px;
        opacity: 0.5;
    }

    .empty-state h3 {
        font-size: 1.1rem;
        color: white;
        margin-bottom: 8px;
    }

    .empty-state p {
        font-size: 0.9rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .stats-row {
            grid-template-columns: 1fr;
        }

        .editor-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
