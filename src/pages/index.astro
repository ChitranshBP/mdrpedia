---
/**
 * MDRPedia — Homepage
 * Clean, focused search-first design
 */

import Layout from "../layouts/Layout.astro";
import { getCollection } from "astro:content";
import { countryToCode } from "../lib/country-flags";

const allDoctors = await getCollection("doctors");
const totalCount = allDoctors.length;
const titanCount = allDoctors.filter((d) => d.data.tier === "TITAN").length;
const eliteCount = allDoctors.filter((d) => d.data.tier === "ELITE").length;
const masterCount = allDoctors.filter((d) => d.data.tier === "MASTER").length;
const countrySet = new Set(allDoctors.map((d) => d.data.geography.country));
const countriesCount = countrySet.size;

// Build search index at build time
const searchIndex = allDoctors
	.filter(
		(d) =>
			d.data.fullName &&
			d.data.fullName.length > 2 &&
			isNaN(Number(d.data.fullName)),
	)
	.map((d) => ({
		id: d.id,
		n: d.data.fullName,
		s: d.data.specialty || "",
		t: d.data.tier || "UNRANKED",
		c: d.data.geography?.country || "",
		cc: countryToCode(d.data.geography?.country || ""),
		img: d.data.portraitUrl && !d.data.portraitUrl.startsWith("data:") ? d.data.portraitUrl : "",
	}))
	.slice(0, 800);

// Featured doctors - Titans for showcase
const featuredDoctors = allDoctors
	.filter((d) => d.data.tier === "TITAN" && d.data.portraitUrl && !d.data.portraitUrl.startsWith("data:"))
	.slice(0, 6);
---

<Layout
	title="MDRPedia — The Free Encyclopedia of Verified Medical Professionals"
>
	<div class="home">
		<!-- Hero -->
		<header class="hero">
			<h1 class="hero__title">MDRPedia</h1>
			<p class="hero__tagline">
				Encyclopedia of verified medical professionals
			</p>
		</header>

		<!-- Search -->
		<form class="search" id="mdr-search-root" action="/search" method="get">
			<div class="search__bar">
				<svg
					class="search__icon"
					viewBox="0 0 24 24"
					fill="none"
					stroke="currentColor"
					stroke-width="2"
				>
					<circle cx="11" cy="11" r="8"></circle>
					<path d="m21 21-4.3-4.3"></path>
				</svg>
				<input
					type="text"
					id="mdr-hero-search"
					name="q"
					class="search__input"
					placeholder="Search doctors by name, specialty, or country..."
					autocomplete="off"
					aria-label="Search MDRPedia"
				/>
				<div class="search__kbd"><kbd>⌘K</kbd></div>
			</div>
			<div class="search-results" id="mdr-search-results" hidden></div>
		</form>

		<!-- Stats Bar -->
		<div class="stats-bar">
			<div class="stat-item">
				<span class="stat-num">{totalCount.toLocaleString()}</span>
				<span class="stat-label">Profiles</span>
			</div>
			<div class="stat-divider"></div>
			<div class="stat-item">
				<span class="stat-num">{countriesCount}</span>
				<span class="stat-label">Countries</span>
			</div>
			<div class="stat-divider"></div>
			<div class="stat-item stat-item--titan">
				<span class="stat-num">{titanCount}</span>
				<span class="stat-label">Titans</span>
			</div>
			<div class="stat-divider"></div>
			<div class="stat-item stat-item--elite">
				<span class="stat-num">{eliteCount}</span>
				<span class="stat-label">Elite</span>
			</div>
			<div class="stat-divider"></div>
			<div class="stat-item stat-item--master">
				<span class="stat-num">{masterCount}</span>
				<span class="stat-label">Master</span>
			</div>
		</div>

		<!-- Featured Titans -->
		{featuredDoctors.length > 0 && (
			<section class="featured">
				<h2 class="section-title">Featured Titans</h2>
				<div class="featured-grid">
					{featuredDoctors.map((doc) => (
						<a href={`/doctors/${doc.id}`} class="featured-card">
							<div class="featured-card__img">
								{doc.data.portraitUrl && (
									<img src={doc.data.portraitUrl} alt={doc.data.fullName} loading="lazy" />
								)}
							</div>
							<div class="featured-card__info">
								<h3>{doc.data.fullName}</h3>
								<p>{doc.data.specialty}</p>
							</div>
						</a>
					))}
				</div>
				<a href="/doctors" class="browse-link">
					Browse all {totalCount} profiles
					<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
						<path d="M5 12h14M12 5l7 7-7 7"/>
					</svg>
				</a>
			</section>
		)}
	</div>
</Layout>

<script define:vars={{ searchIndex }}>
	const DATA = searchIndex;
	const input = document.getElementById("mdr-hero-search");
	const resultsEl = document.getElementById("mdr-search-results");
	let activeIdx = -1;

	function toFlag(cc) {
		if (!cc || cc.length !== 2) return "";
		return String.fromCodePoint(
			...cc.toUpperCase().split("").map((c) => 0x1f1e6 + c.charCodeAt(0) - 65),
		);
	}

	document.addEventListener("keydown", (e) => {
		if ((e.metaKey || e.ctrlKey) && e.key === "k") {
			e.preventDefault();
			input?.focus();
		}
	});

	function renderResults(matches) {
		if (!resultsEl) return;
		if (matches.length === 0) {
			resultsEl.innerHTML = '<div class="no-results">No matching profiles found</div>';
			resultsEl.hidden = false;
			return;
		}
		activeIdx = -1;
		resultsEl.innerHTML = matches
			.map((m, i) => {
				const tierClass = m.t === "TITAN" ? "tier-titan" : m.t === "ELITE" ? "tier-elite" : "tier-master";
				const initials = m.n.split(" ").map((w) => w[0]).filter((_, j) => j < 2).join("").toUpperCase();
				const flag = toFlag(m.cc);
				return `<a href="/doctors/${m.id}" class="result-item ${tierClass}" data-idx="${i}">
					<div class="result-avatar">
						${m.img ? `<img src="${m.img}" alt="Portrait of ${m.n}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'" /><span class="result-initials" style="display:none">${initials}</span>` : `<span class="result-initials">${initials}</span>`}
					</div>
					<div class="result-info">
						<span class="result-name">${m.n}</span>
						<span class="result-meta">${m.s}${m.c ? ` · ${flag} ${m.c}` : ""}</span>
					</div>
					<span class="result-tier">${m.t}</span>
				</a>`;
			})
			.join("");
		resultsEl.hidden = false;
	}

	let timer;
	input?.addEventListener("input", () => {
		clearTimeout(timer);
		timer = setTimeout(() => {
			const q = input.value.trim().toLowerCase();
			if (q.length < 2) {
				resultsEl && (resultsEl.hidden = true);
				return;
			}
			const matches = DATA.filter((d) =>
				`${d.n} ${d.s} ${d.c}`.toLowerCase().includes(q),
			).slice(0, 8);
			renderResults(matches);
		}, 120);
	});

	input?.addEventListener("keydown", (e) => {
		if (!resultsEl || resultsEl.hidden) return;
		const items = resultsEl.querySelectorAll(".result-item");
		if (e.key === "ArrowDown") {
			e.preventDefault();
			activeIdx = Math.min(activeIdx + 1, items.length - 1);
			items.forEach((el, i) => el.classList.toggle("active", i === activeIdx));
		} else if (e.key === "ArrowUp") {
			e.preventDefault();
			activeIdx = Math.max(activeIdx - 1, 0);
			items.forEach((el, i) => el.classList.toggle("active", i === activeIdx));
		} else if (e.key === "Enter" && activeIdx >= 0) {
			e.preventDefault();
			items[activeIdx]?.click();
		} else if (e.key === "Escape") {
			resultsEl.hidden = true;
		}
	});

	document.addEventListener("click", (e) => {
		if (!document.getElementById("mdr-search-root")?.contains(e.target)) {
			resultsEl && (resultsEl.hidden = true);
		}
	});

	input?.addEventListener("focus", () => {
		if (input.value.length >= 2) {
			resultsEl && (resultsEl.hidden = false);
		}
	});
</script>

<style>
	.home {
		max-width: 800px;
		margin: 0 auto;
		padding: 60px 20px 100px;
	}

	/* Hero */
	.hero {
		text-align: center;
		padding: 40px 0 32px;
	}
	.hero__title {
		font-size: 3.5rem;
		font-weight: 800;
		letter-spacing: -0.03em;
		background: linear-gradient(135deg, #fff 0%, rgba(255,255,255,0.8) 100%);
		-webkit-background-clip: text;
		-webkit-text-fill-color: transparent;
		background-clip: text;
		margin-bottom: 8px;
	}
	.hero__tagline {
		font-size: 1.1rem;
		color: var(--text-muted);
		font-weight: 400;
	}

	/* Search */
	.search {
		position: relative;
		max-width: 600px;
		margin: 0 auto 32px;
	}
	.search__bar {
		position: relative;
		display: flex;
		align-items: center;
	}
	.search__icon {
		position: absolute;
		left: 18px;
		width: 20px;
		height: 20px;
		color: var(--text-muted);
		pointer-events: none;
		z-index: 1;
	}
	.search__input {
		width: 100%;
		padding: 16px 80px 16px 52px;
		font-size: 1rem;
		font-family: var(--font-sans);
		background: rgba(255, 255, 255, 0.04);
		border: 1px solid rgba(255, 255, 255, 0.1);
		border-radius: 16px;
		color: var(--text-primary);
		outline: none;
		transition: all 0.2s ease;
	}
	.search__input::placeholder {
		color: var(--text-muted);
	}
	.search__input:focus {
		border-color: var(--accent-purple);
		background: rgba(255, 255, 255, 0.06);
		box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
	}
	.search__kbd {
		position: absolute;
		right: 16px;
		pointer-events: none;
	}
	.search__kbd kbd {
		font-size: 0.7rem;
		font-weight: 600;
		padding: 4px 8px;
		background: rgba(255, 255, 255, 0.06);
		border: 1px solid rgba(255, 255, 255, 0.1);
		border-radius: 6px;
		color: var(--text-muted);
		font-family: var(--font-sans);
	}

	/* Search Results */
	.search-results {
		position: absolute;
		z-index: 100;
		top: calc(100% + 8px);
		left: 0;
		width: 100%;
		background: rgba(22, 22, 42, 0.98);
		border: 1px solid rgba(255, 255, 255, 0.1);
		border-radius: 16px;
		box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.05);
		overflow: hidden;
		max-height: 440px;
		overflow-y: auto;
		backdrop-filter: blur(20px);
	}
	.result-item {
		display: flex;
		align-items: center;
		gap: 14px;
		padding: 14px 18px;
		text-decoration: none;
		color: var(--text-primary);
		transition: all 0.15s ease;
		border-bottom: 1px solid rgba(255, 255, 255, 0.04);
	}
	.result-item:last-child {
		border-bottom: none;
	}
	.result-item:hover,
	.result-item.active {
		background: rgba(139, 92, 246, 0.1);
	}
	.tier-titan.result-item:hover,
	.tier-titan.result-item.active {
		background: rgba(255, 215, 0, 0.08);
	}
	.tier-elite.result-item:hover,
	.tier-elite.result-item.active {
		background: rgba(0, 170, 255, 0.08);
	}

	.result-avatar {
		width: 44px;
		height: 44px;
		border-radius: 12px;
		overflow: hidden;
		flex-shrink: 0;
		background: rgba(255, 255, 255, 0.05);
		display: flex;
		align-items: center;
		justify-content: center;
	}
	.result-avatar img {
		width: 100%;
		height: 100%;
		object-fit: cover;
	}
	.result-initials {
		font-weight: 700;
		font-size: 0.85rem;
		color: var(--text-muted);
	}
	.tier-titan .result-avatar {
		border: 2px solid rgba(255, 215, 0, 0.3);
	}
	.tier-titan .result-initials {
		color: #ffd700;
	}
	.tier-elite .result-avatar {
		border: 2px solid rgba(0, 170, 255, 0.3);
	}
	.tier-elite .result-initials {
		color: #00aaff;
	}

	.result-info {
		flex: 1;
		min-width: 0;
		display: flex;
		flex-direction: column;
		gap: 2px;
	}
	.result-name {
		font-weight: 600;
		font-size: 0.95rem;
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
	}
	.tier-titan .result-name {
		color: #ffd700;
	}
	.result-meta {
		font-size: 0.8rem;
		color: var(--text-muted);
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
	}
	.result-tier {
		font-size: 0.65rem;
		font-weight: 700;
		padding: 4px 10px;
		border-radius: 6px;
		letter-spacing: 0.05em;
		flex-shrink: 0;
	}
	.tier-titan .result-tier {
		background: rgba(255, 215, 0, 0.12);
		color: #ffd700;
	}
	.tier-elite .result-tier {
		background: rgba(0, 170, 255, 0.1);
		color: #00aaff;
	}
	.tier-master .result-tier {
		background: rgba(0, 204, 102, 0.1);
		color: #00cc66;
	}
	.no-results {
		padding: 24px;
		text-align: center;
		color: var(--text-muted);
		font-size: 0.9rem;
	}

	/* Stats Bar */
	.stats-bar {
		display: flex;
		justify-content: center;
		align-items: center;
		gap: 24px;
		padding: 20px 0;
		margin-bottom: 48px;
	}
	.stat-item {
		text-align: center;
	}
	.stat-num {
		display: block;
		font-size: 1.4rem;
		font-weight: 700;
		color: var(--text-primary);
		letter-spacing: -0.02em;
	}
	.stat-label {
		font-size: 0.72rem;
		color: var(--text-muted);
		text-transform: uppercase;
		letter-spacing: 0.08em;
	}
	.stat-item--titan .stat-num { color: #ffd700; }
	.stat-item--elite .stat-num { color: #00aaff; }
	.stat-item--master .stat-num { color: #00cc66; }
	.stat-divider {
		width: 1px;
		height: 32px;
		background: rgba(255, 255, 255, 0.08);
	}

	/* Featured Section */
	.featured {
		margin-top: 32px;
	}
	.section-title {
		font-size: 0.8rem;
		font-weight: 600;
		color: var(--text-muted);
		text-transform: uppercase;
		letter-spacing: 0.1em;
		margin-bottom: 20px;
		text-align: center;
	}
	.featured-grid {
		display: grid;
		grid-template-columns: repeat(3, 1fr);
		gap: 16px;
		margin-bottom: 24px;
	}
	.featured-card {
		display: flex;
		flex-direction: column;
		align-items: center;
		padding: 20px 16px;
		background: rgba(255, 255, 255, 0.02);
		border: 1px solid rgba(255, 255, 255, 0.06);
		border-radius: 16px;
		text-decoration: none;
		transition: all 0.2s ease;
	}
	.featured-card:hover {
		background: rgba(255, 215, 0, 0.04);
		border-color: rgba(255, 215, 0, 0.15);
		transform: translateY(-2px);
	}
	.featured-card__img {
		width: 64px;
		height: 64px;
		border-radius: 50%;
		overflow: hidden;
		margin-bottom: 12px;
		border: 2px solid rgba(255, 215, 0, 0.3);
	}
	.featured-card__img img {
		width: 100%;
		height: 100%;
		object-fit: cover;
	}
	.featured-card__info {
		text-align: center;
	}
	.featured-card__info h3 {
		font-size: 0.9rem;
		font-weight: 600;
		color: #ffd700;
		margin-bottom: 4px;
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
		max-width: 140px;
	}
	.featured-card__info p {
		font-size: 0.75rem;
		color: var(--text-muted);
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
		max-width: 140px;
	}

	.browse-link {
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 8px;
		color: var(--text-secondary);
		font-size: 0.9rem;
		text-decoration: none;
		transition: color 0.15s;
	}
	.browse-link:hover {
		color: var(--text-primary);
	}

	@media (max-width: 640px) {
		.hero__title {
			font-size: 2.5rem;
		}
		.stats-bar {
			gap: 16px;
			flex-wrap: wrap;
		}
		.stat-divider {
			display: none;
		}
		.featured-grid {
			grid-template-columns: repeat(2, 1fr);
		}
	}

	@media (max-width: 480px) {
		.featured-grid {
			grid-template-columns: 1fr;
		}
	}
</style>
