---
import Layout from "../layouts/Layout.astro";
import { getCollection } from "astro:content";
import TierBadge from "../components/TierBadge.astro";

const allDoctors = await getCollection("doctors");

// Grouping by specialty
const communitiesMap = new Map();

allDoctors.forEach((doc) => {
    const specialty = doc.data.specialty;
    if (!communitiesMap.has(specialty)) {
        communitiesMap.set(specialty, []);
    }
    communitiesMap.get(specialty).push(doc);
});

// Sort each community by hIndex and pick the head
const communities = Array.from(communitiesMap.entries())
    .map(([name, members]) => {
        const sortedMembers = members.sort(
            (a, b) => (b.data.hIndex || 0) - (a.data.hIndex || 0),
        );
        return {
            name,
            count: members.length,
            head: sortedMembers[0],
            members: sortedMembers,
        };
    })
    .sort((a, b) => b.count - a.count); // Sort by popularity/size
---

<Layout title="Medical Communities ‚Äî MDRPedia">
    <div class="container py-20">
        <header class="text-center mb-16">
            <h1 class="text-5xl font-bold text-white mb-6">
                Medical Communities
            </h1>
            <p class="text-xl text-gray-400 max-w-2xl mx-auto">
                Explore specialized global networks of medical excellence, led
                by the world's most cited authorities.
            </p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            {
                communities.map((community) => (
                    <div class="community-card bg-[#111119] border border-white/5 rounded-2xl p-8 hover:border-accent-purple/30 transition-all group">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-white mb-1">
                                    {community.name}
                                </h2>
                                <p class="text-accent-purple text-sm font-semibold uppercase tracking-wider">
                                    {community.count} Verified Authorities
                                </p>
                            </div>
                            <div class="h-12 w-12 rounded-full bg-accent-purple/10 flex items-center justify-center text-2xl">
                                üèõÔ∏è
                            </div>
                        </div>

                        <div class="head-profile flex items-center gap-4 p-4 rounded-xl bg-white/5 border border-white/5 mb-6">
                            <div class="h-16 w-16 rounded-full overflow-hidden bg-gray-800 border-2 border-accent-purple/20">
                                {community.head.data.portraitUrl ? (
                                    <img
                                        src={community.head.data.portraitUrl}
                                        alt={community.head.data.fullName}
                                        class="h-full w-full object-cover"
                                    />
                                ) : (
                                    <div class="h-full w-full flex items-center justify-center text-xl bg-accent-purple/10 text-white font-bold">
                                        {community.head.data.fullName[0]}
                                    </div>
                                )}
                            </div>
                            <div class="flex-1">
                                <p class="text-[0.65rem] text-gray-500 font-bold uppercase tracking-widest mb-1">
                                    Community Head
                                </p>
                                <h3 class="text-white font-bold">
                                    {community.head.data.fullName}
                                </h3>
                                <div class="flex items-center gap-2 mt-1">
                                    <TierBadge
                                        tier={community.head.data.tier}
                                        size="xs"
                                    />
                                    <span class="text-xs text-gray-500">
                                        H-Index: {community.head.data.hIndex}
                                    </span>
                                </div>
                            </div>
                            <a
                                href={`/doctors/${community.head.id}`}
                                class="px-4 py-2 rounded-lg bg-white/5 text-xs font-bold text-white hover:bg-white/10 transition-colors"
                            >
                                View Profile
                            </a>
                        </div>

                        <div class="flex flex-wrap gap-2 opacity-60 group-hover:opacity-100 transition-opacity">
                            {community.members.slice(1, 4).map((member) => (
                                <span class="text-xs px-2 py-1 rounded bg-white/5 text-gray-400">
                                    {member.data.fullName}
                                </span>
                            ))}
                            {community.count > 4 && (
                                <span class="text-xs px-2 py-1 rounded bg-white/5 text-gray-500">
                                    +{community.count - 4} more
                                </span>
                            )}
                        </div>
                    </div>
                ))
            }
        </div>
    </div>
</Layout>

<style>
    .community-card {
        transition: transform 0.2s ease-out;
    }
    .community-card:hover {
        transform: translateY(-4px);
    }
</style>
