---
import Layout from "../layouts/Layout.astro";
import { getCollection } from "astro:content";
import TierBadge from "../components/TierBadge.astro";

const allDoctors = await getCollection("doctors");

// Grouping by specialty
const communitiesMap = new Map();

allDoctors.forEach((doc) => {
    const specialty = doc.data.specialty;
    if (!communitiesMap.has(specialty)) {
        communitiesMap.set(specialty, []);
    }
    communitiesMap.get(specialty).push(doc);
});

// Sort each community by hIndex and pick the head
const communities = Array.from(communitiesMap.entries())
    .map(([name, members]) => {
        const sortedMembers = members.sort(
            (a, b) => (b.data.hIndex || 0) - (a.data.hIndex || 0),
        );
        return {
            name,
            count: members.length,
            head: sortedMembers[0],
            members: sortedMembers,
        };
    })
    .sort((a, b) => b.count - a.count); // Sort by popularity/size

const seoTitle =
    "Medical Specialty Communities ‚Äî Verified Professional Networks";
const seoDescription =
    "Browse medical specialties and healthcare communities. Discover community heads and verified authorities in Surgery, Oncology, Cardiology, and more.";
---

<Layout title={seoTitle} description={seoDescription}>
    <div class="container py-20">
        <header class="text-center mb-16">
            <div
                class="inline-block px-4 py-1 rounded-full bg-accent-purple/10 text-accent-purple text-sm font-bold mb-4 border border-accent-purple/20"
            >
                SPECIALIZED NETWORKS
            </div>
            <h1 class="text-5xl font-bold text-white mb-6">
                Medical Communities
            </h1>
            <p class="text-xl text-gray-400 max-w-2xl mx-auto">
                Explore specialized global networks of medical excellence,
                anchored by the world's most cited and influential authorities.
            </p>
        </header>

        <!-- SEO Content Block: Methodology -->
        <section
            class="mb-20 grid grid-cols-1 lg:grid-cols-4 gap-8 items-center bg-[#111119] border border-white/5 rounded-3xl p-10"
        >
            <div class="lg:col-span-3">
                <h2 class="text-2xl font-bold text-white mb-4">
                    How Communities are Ranked
                </h2>
                <p class="text-gray-400 leading-relaxed text-balance">
                    MDRPedia clusters medical professionals into communities
                    based on their verified secondary and primary specialties.
                    The <strong>Community Head</strong> is determined through a combination
                    of their <strong>D-Index (Discipline H-Index)</strong>,
                    total citation count, and verified peer recognitions. This
                    ensures that each community is led by a true authority in
                    their field.
                </p>
                <div class="flex flex-wrap gap-4 mt-8">
                    <div
                        class="flex items-center gap-2 text-sm text-gray-500 bg-white/5 px-3 py-1 rounded-full"
                    >
                        <span class="w-2 h-2 rounded-full bg-accent-purple"
                        ></span>
                        Verified Affiliations
                    </div>
                    <div
                        class="flex items-center gap-2 text-sm text-gray-500 bg-white/5 px-3 py-1 rounded-full"
                    >
                        <span class="w-2 h-2 rounded-full bg-accent-blue"
                        ></span>
                        Citation Impact
                    </div>
                    <div
                        class="flex items-center gap-2 text-sm text-gray-500 bg-white/5 px-3 py-1 rounded-full"
                    >
                        <span class="w-2 h-2 rounded-full bg-accent-emerald"
                        ></span>
                        Peer Verification
                    </div>
                </div>
            </div>
            <div class="hidden lg:block">
                <div
                    class="h-32 w-32 border-4 border-dashed border-white/10 rounded-full flex items-center justify-center mx-auto"
                >
                    <span class="text-4xl">üìä</span>
                </div>
            </div>
        </section>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            {
                communities.map((community) => (
                    <div class="community-card bg-[#111119] border border-white/5 rounded-2xl p-8 hover:border-accent-purple/30 transition-all group">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-white mb-1">
                                    {community.name}
                                </h2>
                                <p class="text-accent-purple text-sm font-semibold uppercase tracking-wider">
                                    {community.count} Verified Authorities
                                </p>
                            </div>
                            <div class="h-12 w-12 rounded-full bg-accent-purple/10 flex items-center justify-center text-2xl">
                                üèõÔ∏è
                            </div>
                        </div>

                        <div class="head-profile flex items-center gap-4 p-4 rounded-xl bg-white/5 border border-white/5 mb-6">
                            <div class="h-16 w-16 rounded-full overflow-hidden bg-gray-800 border-2 border-accent-purple/20">
                                {community.head.data.portraitUrl ? (
                                    <img
                                        src={community.head.data.portraitUrl}
                                        alt={`Head of ${community.name}: ${community.head.data.fullName}`}
                                        class="h-full w-full object-cover"
                                    />
                                ) : (
                                    <div class="h-full w-full flex items-center justify-center text-xl bg-accent-purple/10 text-white font-bold">
                                        {community.head.data.fullName[0]}
                                    </div>
                                )}
                            </div>
                            <div class="flex-1">
                                <p class="text-[0.65rem] text-gray-500 font-bold uppercase tracking-widest mb-1">
                                    Community Head
                                </p>
                                <h3 class="text-white font-bold">
                                    {community.head.data.fullName}
                                </h3>
                                <div class="flex items-center gap-2 mt-1">
                                    <TierBadge
                                        tier={community.head.data.tier}
                                        size="sm"
                                    />
                                    <span class="text-xs text-gray-500 uppercase font-mono tracking-tighter">
                                        D-Index: {community.head.data.hIndex}
                                    </span>
                                </div>
                            </div>
                            <a
                                href={`/doctors/${community.head.id}`}
                                class="px-4 py-2 rounded-lg bg-white/5 text-xs font-bold text-white hover:bg-white/10 transition-colors"
                            >
                                View Profile
                            </a>
                        </div>

                        <div class="flex flex-wrap gap-2 opacity-60 group-hover:opacity-100 transition-opacity">
                            {community.members.slice(1, 4).map((member) => (
                                <span class="text-xs px-2 py-1 rounded bg-white/5 text-gray-400">
                                    {member.data.fullName}
                                </span>
                            ))}
                            {community.count > 4 && (
                                <span class="text-xs px-2 py-1 rounded bg-white/5 text-gray-500">
                                    +{community.count - 4} more
                                </span>
                            )}
                        </div>
                    </div>
                ))
            }
        </div>

        <!-- Semantic SEO Footer Section -->
        <footer class="mt-20 border-t border-white/5 pt-16">
            <div class="prose prose-invert max-w-none">
                <h2 class="text-2xl font-bold text-white mb-6">
                    Frequently Browsed Communities
                </h2>
                <div class="flex flex-wrap gap-x-8 gap-y-4">
                    {
                        communities.map((c) => (
                            <a
                                href={`#${c.name.toLowerCase().replace(/\s+/g, "-")}`}
                                class="text-sm text-gray-500 hover:text-accent-purple transition-colors"
                            >
                                {c.name} Registry
                            </a>
                        ))
                    }
                </div>
                <p class="text-sm text-gray-600 mt-10">
                    Our medical community registry includes authorities across
                    North America, Europe, and Asia, covering over 50+ unique
                    specialties including Neurosurgery, Transplantation, Genomic
                    Medicine, and Global Health.
                </p>
            </div>
        </footer>
    </div>
</Layout>

<style>
    .community-card {
        transition: transform 0.2s ease-out;
    }
    .community-card:hover {
        transform: translateY(-4px);
    }
</style>
