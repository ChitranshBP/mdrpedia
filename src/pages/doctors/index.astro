---
/**
 * MDRPedia ‚Äî Browse All Doctors
 * Displays a searchable grid of all verified doctor profiles
 */
import Layout from "../../layouts/Layout.astro";
import TierBadge from "../../components/TierBadge.astro";
import { getCollection } from "astro:content";

const allDoctors = await getCollection("doctors");

// Sort: Titans first, then Elite, then Master, then Unranked
const tierOrder: Record<string, number> = {
    TITAN: 0,
    ELITE: 1,
    MASTER: 2,
    UNRANKED: 3,
};
const sortedDoctors = allDoctors.sort(
    (a, b) => (tierOrder[a.data.tier] ?? 3) - (tierOrder[b.data.tier] ?? 3),
);
---

<Layout title="Browse All Doctors ‚Äî MDRPedia">
    <section class="browse">
        <div class="container">
            <div class="browse__header">
                <h1 class="browse__title">Browse Verified Profiles</h1>
                <p class="browse__subtitle">
                    {sortedDoctors.length} verified medical professionals in the MDRPedia
                    registry
                </p>
                <div class="browse__search">
                    <svg
                        class="browse__search-icon"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.3-4.3"></path>
                    </svg>
                    <input
                        type="text"
                        id="browse-search"
                        class="browse__search-input"
                        placeholder="Filter by name, specialty, or location..."
                        autocomplete="off"
                    />
                </div>
            </div>

            <!-- Filter bar -->
            <div class="browse__filters">
                <span class="filter-label">Tier:</span>
                <button
                    class="filter-btn filter-btn--active"
                    data-group="tier"
                    data-filter="all">All</button
                >
                <button class="filter-btn" data-group="tier" data-filter="TITAN"
                    >üèÜ Titan</button
                >
                <button class="filter-btn" data-group="tier" data-filter="ELITE"
                    >ü•à Elite</button
                >
                <button
                    class="filter-btn"
                    data-group="tier"
                    data-filter="MASTER">ü•â Master</button
                >

                <span class="filter-divider">|</span>

                <span class="filter-label">Status:</span>
                <button
                    class="filter-btn"
                    data-group="status"
                    data-filter="LIVING">üü¢ Living</button
                >
                <button
                    class="filter-btn"
                    data-group="status"
                    data-filter="HISTORICAL">üèõ Legacy</button
                >
            </div>

            <!-- Doctor Grid -->
            <div class="browse__grid" id="doctor-grid">
                {
                    sortedDoctors.map((doctor) => {
                        const d = doctor.data;
                        const location = [
                            d.geography.city,
                            d.geography.region,
                            d.geography.country,
                        ]
                            .filter(Boolean)
                            .join(", ");

                        return (
                            <a
                                href={`/doctors/${doctor.id}`}
                                class={`browse-card card card--${d.tier.toLowerCase()}`}
                                data-tier={d.tier}
                                data-status={d.status}
                            >
                                <div class="browse-card__top">
                                    <div
                                        class={`browse-card__avatar avatar--${d.tier.toLowerCase()}`}
                                    >
                                        {d.portraitUrl &&
                                        !d.portraitUrl.startsWith("data:") ? (
                                            <img
                                                src={d.portraitUrl}
                                                alt={d.fullName}
                                                class="browse-card__avatar-img"
                                                loading="lazy"
                                            />
                                        ) : (
                                            <span class="browse-card__initials">
                                                {d.fullName
                                                    .split(" ")
                                                    .map((w: string) => w[0])
                                                    .filter(
                                                        (
                                                            _: string,
                                                            i: number,
                                                        ) => i < 2,
                                                    )
                                                    .join("")
                                                    .toUpperCase()}
                                            </span>
                                        )}
                                    </div>
                                    <TierBadge
                                        tier={
                                            d.tier as
                                                | "TITAN"
                                                | "ELITE"
                                                | "MASTER"
                                                | "UNRANKED"
                                        }
                                        size="sm"
                                    />
                                    {d.status === "HISTORICAL" && (
                                        <span class="browse-card__legacy">
                                            Legacy
                                        </span>
                                    )}
                                </div>
                                <h3 class="browse-card__name">{d.fullName}</h3>
                                <p class="browse-card__specialty">
                                    {d.specialty}
                                </p>
                                <p class="browse-card__location">
                                    üìç {location}
                                </p>
                                <div class="browse-card__meta">
                                    <span class="browse-card__stat">
                                        H-index: {d.hIndex}
                                    </span>
                                    <span class="browse-card__stat">
                                        {d.citations ? d.citations.length : 0}{" "}
                                        citations
                                    </span>
                                </div>
                            </a>
                        );
                    })
                }
            </div>
        </div>
    </section>
</Layout>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const buttons =
            document.querySelectorAll<HTMLButtonElement>(".filter-btn");
        const cards = document.querySelectorAll<HTMLElement>(".browse-card");
        const browseSearch = document.getElementById(
            "browse-search",
        ) as HTMLInputElement;

        let currentTier = "all";
        let currentStatus = "all";
        let searchQuery = "";

        function filterCards() {
            cards.forEach((card) => {
                const tierMatch =
                    currentTier === "all" || card.dataset.tier === currentTier;
                const statusMatch =
                    currentStatus === "all" ||
                    card.dataset.status === currentStatus;
                const textMatch =
                    !searchQuery ||
                    (card.textContent || "")
                        .toLowerCase()
                        .includes(searchQuery);

                if (tierMatch && statusMatch && textMatch) {
                    card.style.display = "";
                } else {
                    card.style.display = "none";
                }
            });
        }

        // Text search
        let searchTimer: ReturnType<typeof setTimeout>;
        browseSearch?.addEventListener("input", () => {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => {
                searchQuery = browseSearch.value.trim().toLowerCase();
                filterCards();
            }, 200);
        });

        buttons.forEach((btn) => {
            btn.addEventListener("click", () => {
                const group = btn.dataset.group;
                const filter = btn.dataset.filter || "all";

                if (group === "tier") {
                    document
                        .querySelectorAll(`.filter-btn[data-group="tier"]`)
                        .forEach((b) =>
                            b.classList.remove("filter-btn--active"),
                        );
                    btn.classList.add("filter-btn--active");
                    currentTier = filter;
                } else if (group === "status") {
                    const isActive =
                        btn.classList.contains("filter-btn--active");

                    document
                        .querySelectorAll(`.filter-btn[data-group="status"]`)
                        .forEach((b) =>
                            b.classList.remove("filter-btn--active"),
                        );

                    if (isActive) {
                        currentStatus = "all";
                    } else {
                        btn.classList.add("filter-btn--active");
                        currentStatus = filter;
                    }
                }
                filterCards();
            });
        });
    });
</script>

<style>
    .browse {
        padding: var(--space-3xl) 0;
    }

    .browse__header {
        text-align: center;
        margin-bottom: var(--space-2xl);
    }

    .browse__title {
        font-size: clamp(2rem, 4vw, 3rem);
        font-weight: 800;
        background: linear-gradient(
            135deg,
            var(--accent-purple),
            var(--accent-blue)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: var(--space-sm);
    }

    .browse__subtitle {
        color: var(--text-secondary);
        font-size: 1.1rem;
    }

    .browse__filters {
        display: flex;
        justify-content: center;
        gap: var(--space-sm);
        margin-bottom: var(--space-xl);
        flex-wrap: wrap;
        align-items: center;
    }

    .filter-label {
        color: var(--text-muted);
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 700;
        margin-right: 0.2rem;
    }

    .filter-divider {
        color: rgba(255, 255, 255, 0.1);
        margin: 0 0.5rem;
        font-size: 1.2rem;
        font-weight: 300;
    }

    .filter-btn {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--text-secondary);
        padding: 0.6rem 1.2rem;
        border-radius: var(--radius-full);
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all var(--transition-base);
    }

    .filter-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
    }

    .filter-btn--active {
        background: var(--accent-purple);
        border-color: var(--accent-purple);
        color: white;
    }

    .browse__grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: var(--space-lg);
    }

    .browse-card {
        display: flex;
        flex-direction: column;
        gap: var(--space-xs);
        padding: var(--space-lg);
        text-decoration: none;
        color: inherit;
        transition:
            transform var(--transition-base),
            box-shadow var(--transition-base);
    }

    .browse-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
    }

    /* Browse Search */
    .browse__search {
        position: relative;
        max-width: 500px;
        margin: var(--space-lg) auto 0;
    }
    .browse__search-icon {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 20px;
        color: var(--text-muted);
        pointer-events: none;
    }
    .browse__search-input {
        width: 100%;
        padding: 12px 16px 12px 46px;
        font-size: 1rem;
        font-family: var(--font-sans);
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--radius-full);
        color: white;
        outline: none;
        transition: all 0.2s ease;
    }
    .browse__search-input::placeholder {
        color: var(--text-muted);
    }
    .browse__search-input:focus {
        border-color: var(--accent-purple);
        background: rgba(255, 255, 255, 0.08);
        box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.12);
    }

    /* Card Avatars */
    .browse-card__avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.9rem;
        flex-shrink: 0;
        overflow: hidden;
    }
    .avatar--titan {
        background: linear-gradient(135deg, #300066, #1a0033);
        color: #ffd700;
        border: 2px solid rgba(255, 215, 0, 0.4);
    }
    .avatar--elite {
        background: linear-gradient(135deg, #001a4d, #001133);
        color: #00aaff;
        border: 2px solid rgba(0, 170, 255, 0.3);
    }
    .avatar--master {
        background: linear-gradient(135deg, #003322, #002211);
        color: #00cc66;
        border: 2px solid rgba(0, 204, 102, 0.3);
    }
    .avatar--unranked {
        background: linear-gradient(135deg, #1a1a2e, #16162a);
        color: #8888aa;
        border: 2px solid rgba(136, 136, 170, 0.3);
    }
    .browse-card__avatar-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
    }
    .browse-card__initials {
        font-weight: 700;
    }

    .browse-card__top {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        margin-bottom: var(--space-xs);
    }

    .browse-card__legacy {
        font-size: 0.75rem;
        color: var(--text-muted);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 0.2rem 0.6rem;
        border-radius: var(--radius-full);
        margin-left: auto;
    }

    .browse-card__name {
        font-size: 1.2rem;
        font-weight: 700;
        color: white;
    }

    .browse-card__specialty {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .browse-card__location {
        color: var(--text-muted);
        font-size: 0.85rem;
    }

    .browse-card__meta {
        display: flex;
        gap: var(--space-md);
        margin-top: var(--space-sm);
        padding-top: var(--space-sm);
        border-top: 1px solid rgba(255, 255, 255, 0.06);
    }

    .browse-card__stat {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    @media (max-width: 768px) {
        .browse__grid {
            grid-template-columns: 1fr;
        }

        .browse__filters {
            gap: var(--space-xs);
        }

        .filter-btn {
            padding: 0.5rem 0.8rem;
            font-size: 0.8rem;
        }
    }
</style>
