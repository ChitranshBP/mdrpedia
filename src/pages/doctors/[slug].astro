---
/**
 * MDRPedia â€” Dynamic Doctor Profile Page (Hybrid DB + Static)
 * Priority: Check DB first (for edited profiles with citations/lineage),
 * then fall back to static content for unedited profiles.
 */

import DoctorProfile from "../../layouts/DoctorProfile.astro";
import HiddenAIContext from "../../components/SEO/HiddenAIContext.astro";
import { getEntry } from "astro:content";
import { prisma } from "../../lib/prisma";
import type { ProfileData } from "../../lib/types";
import type { CollectionEntry } from "astro:content";
import { mapDbProfileToProps } from "../../lib/profile-mapper";

export const prerender = false;

const { slug } = Astro.params;
if (!slug) return Astro.redirect("/");

// Type definitions for profile data sources
type StaticDoctor = CollectionEntry<"doctors">;

let profileData: ProfileData;
let doctorSource: unknown;

// 1. Try Database FIRST (for profiles that have been imported and edited)
// This ensures admin edits (citations, lineage, etc.) are visible
let dbProfile = null;
try {
    dbProfile = await prisma.profile.findUnique({
        where: { slug },
        include: {
            geography: true,
            affiliations: { include: { hospital: true } },
            citations: true,
            awards: true,
            techniques: true,
            impact_metrics: true,
            legacy_timeline: true,
            // Mentor lineage - fetch the mentor profile
            mentored_by: {
                select: { id: true, slug: true, full_name: true, title: true },
            },
            // Mentees - profiles this doctor mentored
            mentees: {
                select: { id: true, slug: true, full_name: true, title: true },
            },
            // Media (videos, images, documents)
            media: {
                orderBy: [{ is_featured: "desc" }, { sort_order: "asc" }],
            },
        },
    });
} catch (e) {
    console.error(`Error fetching profile from DB for ${slug}:`, e);
    // Ignore DB error and fall back to static
}

// Store profile ID for analytics tracking
let resolvedProfileId: string | undefined = undefined;

if (dbProfile) {
    // Database profile found - use it (includes any admin edits)
    profileData = mapDbProfileToProps(dbProfile);
    doctorSource = dbProfile;
    resolvedProfileId = dbProfile.id;
} else {
    // 2. Fallback to Static Content (for profiles not yet imported to DB)
    const staticDoctor = await getEntry("doctors", slug);

    if (staticDoctor) {
        const d = staticDoctor.data as any;
        profileData = {
            fullName: d.fullName,
            title: d.title,
            specialty: d.specialty,
            subSpecialty: d.subSpecialty,
            geography: d.geography,
            status: d.status,
            tier: d.tier,
            rankingScore: d.rankingScore,
            hIndex: d.hIndex,
            yearsActive: d.yearsActive,
            verifiedSurgeries: d.verifiedSurgeries,
            biography: d.biography,
            portraitUrl: d.portraitUrl,
            galleryUrls: d.galleryUrls,
            livesSaved: d.livesSaved,
            techniquesInvented: d.techniquesInvented,
            hasInvention: d.hasInvention,
            dateOfBirth: d.dateOfBirth,
            dateOfDeath: d.dateOfDeath,
            citations: d.citations, // Direct assignment since ProfileData allows nulls
            awards: d.awards,
            timeline: d.timeline,
            npiNumber: d.npiNumber,
            orcidId: d.orcidId,
            medicalSpecialty: d.medicalSpecialty,
            knowsAbout: d.knowsAbout,
            rareConditions: d.rareConditions,
            affiliations: d.affiliations,
            mentors: d.mentors,
            students: d.students,
            aiSummary: d.aiSummary,
            media: d.media,
            totalImpact:
                (d.livesSaved || 0) +
                (d.verifiedSurgeries || 0) +
                Math.floor(
                    (d.citations?.reduce(
                        (acc: number, c: any) => acc + (c.citationCount || 0),
                        0,
                    ) || 0) / 100,
                ),
        };
        doctorSource = staticDoctor;
    } else {
        // Profile not found in DB or static content
        return Astro.redirect("/404");
    }
}
---

<HiddenAIContext doctor={doctorSource as any} />
<DoctorProfile doctor={profileData} profileId={resolvedProfileId} />
