---
/**
 * MDRPedia â€” Video Embed Component
 * Responsive video player with lazy loading and privacy-enhanced embeds
 */

interface Props {
    url: string;
    title?: string;
    thumbnail?: string;
    autoplay?: boolean;
}

const { url, title = 'Video', thumbnail, autoplay = false } = Astro.props;

// Parse video URL to get provider and ID
function parseVideoUrl(videoUrl: string): { provider: string; id: string; embedUrl: string } | null {
    // YouTube
    const youtubeMatch = videoUrl.match(/(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
    if (youtubeMatch) {
        const id = youtubeMatch[1];
        return {
            provider: 'youtube',
            id,
            embedUrl: `https://www.youtube-nocookie.com/embed/${id}?rel=0&modestbranding=1${autoplay ? '&autoplay=1' : ''}`
        };
    }

    // Vimeo
    const vimeoMatch = videoUrl.match(/vimeo\.com\/(?:video\/)?(\d+)/);
    if (vimeoMatch) {
        const id = vimeoMatch[1];
        return {
            provider: 'vimeo',
            id,
            embedUrl: `https://player.vimeo.com/video/${id}?dnt=1${autoplay ? '&autoplay=1' : ''}`
        };
    }

    // Direct video URL (mp4, webm, etc.)
    if (videoUrl.match(/\.(mp4|webm|ogg)$/i)) {
        return {
            provider: 'direct',
            id: '',
            embedUrl: videoUrl
        };
    }

    return null;
}

const videoInfo = parseVideoUrl(url);
const youtubeThumb = videoInfo?.provider === 'youtube'
    ? `https://img.youtube.com/vi/${videoInfo.id}/maxresdefault.jpg`
    : null;
const displayThumb = thumbnail || youtubeThumb;
---

<div class="video-embed" data-video-url={videoInfo?.embedUrl || url} data-provider={videoInfo?.provider || 'unknown'}>
    {displayThumb && !autoplay ? (
        <div class="video-thumbnail">
            <img src={displayThumb} alt={title} loading="lazy" />
            <button class="play-button" aria-label="Play video">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <polygon points="5 3 19 12 5 21 5 3"/>
                </svg>
            </button>
            {title && <span class="video-title">{title}</span>}
        </div>
    ) : videoInfo?.provider === 'direct' ? (
        <video controls preload="metadata" class="video-player">
            <source src={url} type={url.endsWith('.webm') ? 'video/webm' : 'video/mp4'} />
            Your browser does not support the video tag.
        </video>
    ) : (
        <iframe
            src={videoInfo?.embedUrl || url}
            title={title}
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
            loading="lazy"
            class="video-iframe"
        ></iframe>
    )}
</div>

<script>
    // Lazy load video on thumbnail click
    document.querySelectorAll('.video-embed .video-thumbnail').forEach((thumbnail) => {
        thumbnail.addEventListener('click', () => {
            const embed = thumbnail.closest('.video-embed') as HTMLElement;
            if (!embed) return;

            const videoUrl = embed.dataset.videoUrl;
            const provider = embed.dataset.provider;

            if (!videoUrl) return;

            if (provider === 'direct') {
                const video = document.createElement('video');
                video.controls = true;
                video.autoplay = true;
                video.className = 'video-player';
                video.innerHTML = `<source src="${videoUrl}" type="video/mp4">`;
                embed.innerHTML = '';
                embed.appendChild(video);
            } else {
                const iframe = document.createElement('iframe');
                iframe.src = videoUrl + (videoUrl.includes('?') ? '&' : '?') + 'autoplay=1';
                iframe.title = 'Video';
                iframe.frameBorder = '0';
                iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
                iframe.allowFullscreen = true;
                iframe.className = 'video-iframe';
                embed.innerHTML = '';
                embed.appendChild(iframe);
            }
        });
    });
</script>

<style>
    .video-embed {
        position: relative;
        width: 100%;
        aspect-ratio: 16 / 9;
        background: #0a0a12;
        border-radius: 12px;
        overflow: hidden;
    }

    .video-thumbnail {
        position: relative;
        width: 100%;
        height: 100%;
        cursor: pointer;
    }

    .video-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .play-button {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 72px;
        height: 72px;
        border-radius: 50%;
        background: rgba(139, 92, 246, 0.9);
        border: none;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
    }

    .play-button:hover {
        transform: translate(-50%, -50%) scale(1.1);
        background: rgba(139, 92, 246, 1);
    }

    .play-button svg {
        width: 28px;
        height: 28px;
        margin-left: 4px;
    }

    .video-title {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 16px;
        background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
        color: white;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .video-iframe,
    .video-player {
        width: 100%;
        height: 100%;
        border: none;
    }

    .video-player {
        background: #000;
    }
</style>
