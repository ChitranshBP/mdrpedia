---
/**
 * MDRPedia â€” Animated Stats Component
 * Interactive stats with counting animations and visual progress indicators
 */

interface Props {
    hIndex: number;
    yearsActive: number;
    verifiedSurgeries: number;
    livesSaved: number;
    citationCount?: number;
    tier: string;
}

const { hIndex, yearsActive, verifiedSurgeries, livesSaved, citationCount = 0, tier } = Astro.props;

// Calculate percentile based on tier
const percentiles: Record<string, number> = {
    TITAN: 99.99,
    ELITE: 99,
    MASTER: 97,
    UNRANKED: 50
};

const percentile = percentiles[tier] || 50;

// H-Index benchmarks (approximate for medical field)
const hIndexMax = 100;
const hIndexPercentage = Math.min((hIndex / hIndexMax) * 100, 100);

// Years active benchmark
const yearsMax = 50;
const yearsPercentage = Math.min((yearsActive / yearsMax) * 100, 100);
---

<div class="animated-stats" data-tier={tier}>
    <div class="stats-grid">
        <!-- H-Index with Progress Ring -->
        <div class="stat-card stat-card--primary">
            <div class="stat-ring" data-percentage={hIndexPercentage}>
                <svg viewBox="0 0 100 100">
                    <circle class="stat-ring__bg" cx="50" cy="50" r="42"/>
                    <circle
                        class="stat-ring__progress"
                        cx="50"
                        cy="50"
                        r="42"
                        style={`--progress: ${hIndexPercentage}`}
                    />
                </svg>
                <div class="stat-ring__value">
                    <span class="counter" data-target={hIndex}>0</span>
                </div>
            </div>
            <div class="stat-card__label">H-Index</div>
            <div class="stat-card__sublabel">Research Impact</div>
        </div>

        <!-- Years Active -->
        <div class="stat-card">
            <div class="stat-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
            </div>
            <div class="stat-value">
                <span class="counter" data-target={yearsActive}>0</span>
                <span class="stat-unit">years</span>
            </div>
            <div class="stat-card__label">Experience</div>
            <div class="stat-bar">
                <div class="stat-bar__fill" style={`--width: ${yearsPercentage}%`}></div>
            </div>
        </div>

        <!-- Citations -->
        {citationCount > 0 && (
            <div class="stat-card">
                <div class="stat-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5C7 4 7 7 7 7"/>
                        <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5C17 4 17 7 17 7"/>
                        <path d="M4 22h16"/>
                        <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/>
                        <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/>
                        <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/>
                    </svg>
                </div>
                <div class="stat-value">
                    <span class="counter" data-target={citationCount}>0</span>
                </div>
                <div class="stat-card__label">Total Citations</div>
            </div>
        )}

        <!-- Surgeries / Procedures -->
        {verifiedSurgeries > 0 && (
            <div class="stat-card">
                <div class="stat-icon stat-icon--success">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                </div>
                <div class="stat-value">
                    <span class="counter" data-target={verifiedSurgeries}>0</span>
                </div>
                <div class="stat-card__label">Verified Procedures</div>
            </div>
        )}

        <!-- Lives Saved -->
        {livesSaved > 0 && (
            <div class="stat-card stat-card--highlight">
                <div class="stat-icon stat-icon--heart">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                    </svg>
                </div>
                <div class="stat-value">
                    <span class="counter" data-target={livesSaved}>0</span>
                </div>
                <div class="stat-card__label">Lives Impacted</div>
            </div>
        )}

        <!-- Global Ranking -->
        <div class="stat-card stat-card--rank">
            <div class="rank-display">
                <span class="rank-prefix">Top</span>
                <span class="rank-value counter" data-target={100 - percentile} data-suffix="%">0</span>
            </div>
            <div class="stat-card__label">Global Ranking</div>
            <div class="stat-card__sublabel">Among Specialists</div>
        </div>
    </div>
</div>

<script>
    // Intersection Observer for triggering animations
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('animate');
                animateCounters(entry.target);
                observer.unobserve(entry.target);
            }
        });
    }, { threshold: 0.2 });

    document.querySelectorAll('.animated-stats').forEach(el => {
        observer.observe(el);
    });

    function animateCounters(container: Element) {
        const counters = container.querySelectorAll('.counter');
        const duration = 2000;

        counters.forEach(counter => {
            const target = parseInt(counter.getAttribute('data-target') || '0');
            const suffix = counter.getAttribute('data-suffix') || '';
            const start = 0;
            const startTime = performance.now();

            function updateCounter(currentTime: number) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);

                // Easing function (ease-out-expo)
                const easeProgress = 1 - Math.pow(1 - progress, 3);
                const current = Math.floor(start + (target - start) * easeProgress);

                counter.textContent = current.toLocaleString() + suffix;

                if (progress < 1) {
                    requestAnimationFrame(updateCounter);
                } else {
                    counter.textContent = target.toLocaleString() + suffix;
                }
            }

            requestAnimationFrame(updateCounter);
        });
    }
</script>

<style>
    .animated-stats {
        margin: var(--space-xl) 0;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: var(--space-md);
    }

    .stat-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: var(--space-lg);
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        text-align: center;
        transition: all var(--transition-base);
        opacity: 0;
        transform: translateY(20px);
    }

    .animated-stats.animate .stat-card {
        opacity: 1;
        transform: translateY(0);
    }

    .stat-card:nth-child(1) { transition-delay: 0s; }
    .stat-card:nth-child(2) { transition-delay: 0.1s; }
    .stat-card:nth-child(3) { transition-delay: 0.2s; }
    .stat-card:nth-child(4) { transition-delay: 0.3s; }
    .stat-card:nth-child(5) { transition-delay: 0.4s; }
    .stat-card:nth-child(6) { transition-delay: 0.5s; }

    .stat-card:hover {
        transform: translateY(-4px);
        border-color: var(--accent-purple);
        box-shadow: 0 8px 24px rgba(139, 92, 246, 0.15);
    }

    .stat-card--primary {
        grid-row: span 2;
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(99, 102, 241, 0.05));
        border-color: rgba(139, 92, 246, 0.3);
    }

    .stat-card--highlight {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.05));
        border-color: rgba(239, 68, 68, 0.3);
    }

    .stat-card--rank {
        background: linear-gradient(135deg, rgba(234, 179, 8, 0.1), rgba(202, 138, 4, 0.05));
        border-color: rgba(234, 179, 8, 0.3);
    }

    /* Progress Ring */
    .stat-ring {
        position: relative;
        width: 100px;
        height: 100px;
        margin-bottom: var(--space-sm);
    }

    .stat-ring svg {
        transform: rotate(-90deg);
    }

    .stat-ring__bg {
        fill: none;
        stroke: var(--border-subtle);
        stroke-width: 8;
    }

    .stat-ring__progress {
        fill: none;
        stroke: var(--accent-purple);
        stroke-width: 8;
        stroke-linecap: round;
        stroke-dasharray: 264;
        stroke-dashoffset: 264;
        transition: stroke-dashoffset 2s ease-out;
    }

    .animated-stats.animate .stat-ring__progress {
        stroke-dashoffset: calc(264 - (264 * var(--progress) / 100));
    }

    .stat-ring__value {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: var(--font-mono);
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--accent-purple);
    }

    /* Stat Icons */
    .stat-icon {
        margin-bottom: var(--space-sm);
        color: var(--accent-purple);
    }

    .stat-icon--success {
        color: #22c55e;
    }

    .stat-icon--heart {
        color: #ef4444;
    }

    /* Stat Values */
    .stat-value {
        display: flex;
        align-items: baseline;
        gap: 4px;
        margin-bottom: var(--space-xs);
    }

    .stat-value .counter {
        font-family: var(--font-mono);
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .stat-unit {
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    /* Labels */
    .stat-card__label {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 2px;
    }

    .stat-card__sublabel {
        font-size: 0.7rem;
        color: var(--text-muted);
    }

    /* Progress Bar */
    .stat-bar {
        width: 100%;
        height: 4px;
        background: var(--border-subtle);
        border-radius: 2px;
        margin-top: var(--space-sm);
        overflow: hidden;
    }

    .stat-bar__fill {
        height: 100%;
        width: 0;
        background: linear-gradient(90deg, var(--accent-purple), #6366f1);
        border-radius: 2px;
        transition: width 2s ease-out;
    }

    .animated-stats.animate .stat-bar__fill {
        width: var(--width);
    }

    /* Rank Display */
    .rank-display {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: var(--space-sm);
    }

    .rank-prefix {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--text-muted);
    }

    .rank-value {
        font-family: var(--font-mono);
        font-size: 2rem;
        font-weight: 700;
        color: #eab308;
    }

    @media (max-width: 640px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .stat-card--primary {
            grid-row: auto;
            grid-column: span 2;
        }

        .stat-ring {
            width: 80px;
            height: 80px;
        }

        .stat-ring__value {
            font-size: 1.5rem;
        }
    }
</style>
